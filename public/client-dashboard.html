<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Dashboard</title>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
      background: #f7fafc;
      color: #2d3748;
      min-height: 100vh;
    }

    .header {
      background: white;
      border-bottom: 1px solid #e2e8f0;
      padding: 20px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .header h1 {
      font-size: 24px;
      font-weight: 700;
      color: #1a202c;
    }

    .business-name {
      font-size: 14px;
      color: #718096;
      font-weight: 500;
    }

    .logout-btn {
      padding: 10px 20px;
      background: #e53e3e;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 14px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .logout-btn:hover {
      background: #c53030;
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: white;
      padding: 24px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
    }

    .stat-label {
      font-size: 13px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 8px;
    }

    .stat-value {
      font-size: 32px;
      font-weight: 700;
      color: #1a202c;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #718096;
      font-size: 16px;
    }

    .calls-section {
      background: white;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
      border: 1px solid #e2e8f0;
      overflow: hidden;
    }

    .section-header {
      padding: 24px 32px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .section-title {
      font-size: 18px;
      font-weight: 700;
      color: #1a202c;
    }

    .search-box {
      padding: 10px 16px;
      border: 1px solid #cbd5e0;
      border-radius: 6px;
      font-size: 14px;
      width: 300px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: #f7fafc;
    }

    th {
      text-align: left;
      padding: 16px 32px;
      font-size: 13px;
      font-weight: 600;
      color: #4a5568;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      border-bottom: 1px solid #e2e8f0;
    }

    td {
      padding: 16px 32px;
      border-bottom: 1px solid #f7fafc;
      font-size: 14px;
    }

    tbody tr:hover {
      background: #f7fafc;
      cursor: pointer;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 12px;
      border-radius: 12px;
      font-size: 12px;
      font-weight: 600;
      text-transform: capitalize;
    }

    .status-completed {
      background: #c6f6d5;
      color: #22543d;
    }

    .status-ongoing {
      background: #feebc8;
      color: #7c2d12;
    }

    .category-badge {
      display: inline-block;
      padding: 5px 12px;
      border-radius: 6px;
      font-size: 12px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .category-new-lead { background: rgba(16, 185, 129, 0.15); color: #047857; }
    .category-existing-client { background: rgba(59, 130, 246, 0.15); color: #1e40af; }
    .category-attorney { background: rgba(255, 0, 255, 0.15); color: #a21caf; }
    .category-insurance { background: rgba(251, 191, 36, 0.15); color: #92400e; }
    .category-medical { background: rgba(239, 68, 68, 0.15); color: #991b1b; }
    .category-other { background: rgba(156, 163, 175, 0.15); color: #374151; }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 0;
      border-radius: 12px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
    }

    .modal-header {
      padding: 24px 32px;
      border-bottom: 1px solid #e2e8f0;
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: #1a202c;
    }

    .close {
      font-size: 32px;
      font-weight: 300;
      color: #a0aec0;
      cursor: pointer;
      line-height: 1;
    }

    .close:hover {
      color: #718096;
    }

    .modal-body {
      padding: 32px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    .field {
      padding: 16px;
      background: #f7fafc;
      border-radius: 8px;
    }

    .field-label {
      font-size: 12px;
      font-weight: 600;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .field-value {
      font-size: 15px;
      font-weight: 500;
      color: #1a202c;
    }

    .transcript-section {
      margin-top: 24px;
    }

    .transcript-title {
      font-size: 16px;
      font-weight: 700;
      color: #1a202c;
      margin-bottom: 16px;
    }

    .transcript-box {
      background: #f7fafc;
      border: 1px solid #e2e8f0;
      border-radius: 8px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .transcript-message {
      margin-bottom: 16px;
      padding: 12px;
      border-radius: 8px;
    }

    .transcript-user {
      background: white;
      border-left: 3px solid #667eea;
    }

    .transcript-agent {
      background: white;
      border-left: 3px solid #48bb78;
    }

    .transcript-role {
      font-size: 11px;
      font-weight: 700;
      color: #718096;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      margin-bottom: 6px;
    }

    .audio-section {
      margin-top: 24px;
    }

    audio {
      width: 100%;
      border-radius: 8px;
    }

    @media (max-width: 768px) {
      .field-grid {
        grid-template-columns: 1fr;
      }

      .search-box {
        width: 100%;
        margin-top: 12px;
      }

      .section-header {
        flex-direction: column;
        align-items: stretch;
      }

      table {
        font-size: 13px;
      }

      th, td {
        padding: 12px 16px;
      }
    }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>Dashboard</h1>
      <div class="business-name" id="business-name">Loading...</div>
    </div>
    <button class="logout-btn" onclick="logout()">Logout</button>
  </div>

  <div class="container">
    <div id="loading" class="loading">Loading your dashboard...</div>

    <div id="dashboard-content" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">Total Calls</div>
          <div class="stat-value" id="total-calls">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">New Leads</div>
          <div class="stat-value" id="new-leads">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Existing Clients</div>
          <div class="stat-value" id="existing-clients">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">Other Calls</div>
          <div class="stat-value" id="other-calls">0</div>
        </div>
      </div>

      <div class="calls-section">
        <div class="section-header">
          <div class="section-title">Recent Calls</div>
          <input type="text" class="search-box" id="search-box" placeholder="Search calls...">
        </div>
        <table id="calls-table">
          <thead>
            <tr>
              <th>Phone Number</th>
              <th>Date</th>
              <th>Duration</th>
              <th>Status</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody id="calls-tbody">
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Call Detail Modal -->
  <div id="call-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Call Details</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let allCalls = [];
    let categories = {};

    // Check authentication and load user data
    async function checkAuth() {
      try {
        const response = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        if (!response.ok) {
          // Not logged in, redirect to login
          window.location.href = '/client-portal';
          return;
        }

        currentUser = await response.json();
        document.getElementById('business-name').textContent = currentUser.business_name;

        // Load data
        await loadDashboard();
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/client-portal';
      }
    }

    async function loadDashboard() {
      try {
        // Load categories
        const catResponse = await fetch('/api/categories', {
          credentials: 'include'
        });
        if (catResponse.ok) {
          categories = await catResponse.json();
        }

        // Load all calls
        const callsResponse = await fetch('/api/agent-summary', {
          credentials: 'include'
        });

        if (!callsResponse.ok) {
          throw new Error('Failed to load calls');
        }

        const data = await callsResponse.json();

        // Filter calls to only show this client's agent(s)
        allCalls = data.all_calls.filter(call =>
          currentUser.agent_ids.includes(call.agent_id)
        );

        renderDashboard();
      } catch (error) {
        console.error('Error loading dashboard:', error);
        document.getElementById('loading').textContent = 'Error loading dashboard. Please try again.';
      }
    }

    function renderDashboard() {
      // Calculate stats
      const totalCalls = allCalls.length;
      const newLeads = allCalls.filter(call => categories[call.call_id]?.category === 'New Lead').length;
      const existingClients = allCalls.filter(call => categories[call.call_id]?.category === 'Existing Client').length;
      const otherCalls = allCalls.filter(call => {
        const cat = categories[call.call_id]?.category;
        return cat === 'Attorney' || cat === 'Insurance' || cat === 'Medical' || cat === 'Other' || !cat;
      }).length;

      document.getElementById('total-calls').textContent = totalCalls;
      document.getElementById('new-leads').textContent = newLeads;
      document.getElementById('existing-clients').textContent = existingClients;
      document.getElementById('other-calls').textContent = otherCalls;

      // Render calls table
      renderCallsTable(allCalls);

      // Show dashboard
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'block';
    }

    function renderCallsTable(calls) {
      const tbody = document.getElementById('calls-tbody');

      if (calls.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px; color: #a0aec0;">No calls found</td></tr>';
        return;
      }

      // Sort by date (newest first)
      const sortedCalls = [...calls].sort((a, b) =>
        (b.start_timestamp || 0) - (a.start_timestamp || 0)
      );

      tbody.innerHTML = sortedCalls.map(call => {
        const date = call.start_timestamp
          ? new Date(call.start_timestamp).toLocaleString()
          : 'N/A';
        const duration = formatDuration(call.duration_minutes || 0);
        const status = call.end_timestamp ? 'completed' : 'ongoing';
        const phoneNumber = call.from_number || call.to_number || call.customer_number || 'N/A';
        const category = categories[call.call_id]?.category || 'Uncategorized';

        return `
          <tr onclick="openCallModal('${call.call_id}')">
            <td>${phoneNumber}</td>
            <td>${date}</td>
            <td>${duration}</td>
            <td><span class="status-badge status-${status}">${status}</span></td>
            <td>${getCategoryBadge(category)}</td>
          </tr>
        `;
      }).join('');
    }

    function formatDuration(minutes) {
      const mins = Math.floor(minutes);
      const secs = Math.round((minutes - mins) * 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function getCategoryBadge(category) {
      const className = category.toLowerCase().replace(/\s+/g, '-');
      return `<span class="category-badge category-${className}">${category}</span>`;
    }

    function openCallModal(callId) {
      const call = allCalls.find(c => c.call_id === callId);
      if (!call) return;

      const modal = document.getElementById('call-modal');
      const modalBody = document.getElementById('modal-body');

      const date = call.start_timestamp ? new Date(call.start_timestamp).toLocaleString() : 'N/A';
      const endDate = call.end_timestamp ? new Date(call.end_timestamp).toLocaleString() : 'Ongoing';
      const duration = formatDuration(call.duration_minutes || 0);
      const phoneNumber = call.from_number || call.to_number || call.customer_number || 'N/A';
      const status = call.end_timestamp ? 'Completed' : 'Ongoing';
      const category = categories[call.call_id]?.category || 'Uncategorized';

      // Format transcript
      let transcriptHTML = '<div class="transcript-box">';
      let transcriptData = call.transcript || call.transcript_object;

      if (typeof transcriptData === 'string') {
        try {
          transcriptData = JSON.parse(transcriptData);
        } catch (e) {}
      }

      if (Array.isArray(transcriptData)) {
        transcriptData.forEach(msg => {
          const role = (msg.role || 'unknown').toUpperCase();
          const content = msg.content || '';
          const className = msg.role === 'user' ? 'transcript-user' : 'transcript-agent';
          transcriptHTML += `
            <div class="transcript-message ${className}">
              <div class="transcript-role">${role}</div>
              <div>${content}</div>
            </div>
          `;
        });
      } else if (typeof transcriptData === 'string') {
        transcriptHTML += `<div style="white-space: pre-wrap;">${transcriptData}</div>`;
      } else {
        transcriptHTML += '<div style="color: #a0aec0; font-style: italic;">No transcript available</div>';
      }
      transcriptHTML += '</div>';

      modalBody.innerHTML = `
        <div class="field-grid">
          <div class="field">
            <div class="field-label">Phone Number</div>
            <div class="field-value">${phoneNumber}</div>
          </div>
          <div class="field">
            <div class="field-label">Duration</div>
            <div class="field-value">${duration}</div>
          </div>
          <div class="field">
            <div class="field-label">Start Time</div>
            <div class="field-value">${date}</div>
          </div>
          <div class="field">
            <div class="field-label">End Time</div>
            <div class="field-value">${endDate}</div>
          </div>
          <div class="field">
            <div class="field-label">Status</div>
            <div class="field-value"><span class="status-badge status-${status.toLowerCase()}">${status}</span></div>
          </div>
          <div class="field">
            <div class="field-label">Category</div>
            <div class="field-value">${getCategoryBadge(category)}</div>
          </div>
        </div>

        ${call.recording_url ? `
          <div class="audio-section">
            <div class="transcript-title">Call Recording</div>
            <audio controls>
              <source src="${call.recording_url}" type="audio/mpeg">
              Your browser does not support the audio element.
            </audio>
          </div>
        ` : ''}

        <div class="transcript-section">
          <div class="transcript-title">Call Transcript</div>
          ${transcriptHTML}
        </div>
      `;

      modal.style.display = 'block';
    }

    function closeModal() {
      const modal = document.getElementById('call-modal');
      const audioElements = modal.querySelectorAll('audio');
      audioElements.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
      });
      modal.style.display = 'none';
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/client-portal';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/client-portal';
      }
    }

    // Search functionality
    document.getElementById('search-box').addEventListener('input', (e) => {
      const searchTerm = e.target.value.toLowerCase();
      const filteredCalls = allCalls.filter(call => {
        const phoneNumber = call.from_number || call.to_number || call.customer_number || '';
        const category = categories[call.call_id]?.category || '';
        return phoneNumber.toLowerCase().includes(searchTerm) ||
               category.toLowerCase().includes(searchTerm);
      });
      renderCallsTable(filteredCalls);
    });

    // Close modal on click outside
    window.onclick = function(event) {
      const modal = document.getElementById('call-modal');
      if (event.target === modal) {
        closeModal();
      }
    };

    // Initialize
    checkAuth();
  </script>
</body>
</html>
