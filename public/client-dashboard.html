<!DOCTYPE html>
<!-- Chart fix deployed: 2025-11-22 | Dynamic scaling + Mobile professional design -->
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Client Dashboard</title>

  <!-- Favicon and Home Screen Icons -->
  <link rel="icon" type="image/png" href="https://storage.googleapis.com/msgsndr/lneM3M1j3P5i0JYeNK18/media/68e5a3ac2cc261cd1cbe4769.png">
  <link rel="apple-touch-icon" href="https://storage.googleapis.com/msgsndr/lneM3M1j3P5i0JYeNK18/media/68e5a3ac2cc261cd1cbe4769.png">
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="apple-mobile-web-app-title" content="SaveYa">
  <meta name="theme-color" content="#0d1117">

  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    html {
      overflow-x: hidden;
    }

    body {
      font-family: 'JetBrains Mono', 'Courier New', monospace, -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto;
      background: #0d1117;
      color: #e6edf3;
      min-height: 100vh;
      overflow-x: hidden;
    }

    .header {
      background: rgba(13, 17, 23, 0.95);
      backdrop-filter: blur(20px);
      border-bottom: 1px solid rgba(0, 255, 255, 0.2);
      padding: 24px 32px;
      display: flex;
      justify-content: space-between;
      align-items: center;
      box-shadow: 0 4px 16px rgba(0, 255, 255, 0.15);
      position: sticky;
      top: 0;
      z-index: 100;
    }

    .header h1 {
      font-size: 28px;
      font-weight: 700;
      color: #00FFFF;
      text-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      letter-spacing: 1px;
    }

    .business-name {
      font-size: 13px;
      color: #9ca3af;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-top: 4px;
    }

    .logout-btn {
      padding: 12px 24px;
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(220, 38, 38, 0.2));
      color: #ff6b6b;
      border: 1px solid rgba(239, 68, 68, 0.4);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1px;
    }

    .logout-btn:hover {
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.3), rgba(220, 38, 38, 0.3));
      border-color: #ef4444;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(239, 68, 68, 0.3);
    }

    .container {
      max-width: 1400px;
      margin: 0 auto;
      padding: 32px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 20px;
      margin-bottom: 32px;
    }

    .stat-card {
      background: rgba(30, 36, 44, 0.6);
      backdrop-filter: blur(10px);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.2);
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    .stat-card:hover {
      transform: translateY(-4px);
      box-shadow: 0 12px 32px rgba(0, 255, 255, 0.2);
      border-color: rgba(0, 255, 255, 0.4);
    }

    .stat-label {
      font-size: 12px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 12px;
    }

    .stat-value {
      font-size: 42px;
      font-weight: 700;
      color: #fafafa;
      text-shadow: none;
      font-family: 'JetBrains Mono', monospace;
    }

    .loading {
      text-align: center;
      padding: 60px 20px;
      color: #9ca3af;
      font-size: 16px;
    }

    /* Skeleton Loading States */
    .skeleton {
      background: linear-gradient(90deg, rgba(30, 36, 44, 0.6) 25%, rgba(48, 54, 61, 0.6) 50%, rgba(30, 36, 44, 0.6) 75%);
      background-size: 200% 100%;
      animation: shimmer 1.5s infinite;
      border-radius: 8px;
    }

    @keyframes shimmer {
      0% {
        background-position: 200% 0;
      }
      100% {
        background-position: -200% 0;
      }
    }

    .skeleton-stat-card {
      background: rgba(30, 36, 44, 0.6);
      backdrop-filter: blur(10px);
      padding: 28px;
      border-radius: 16px;
      border: 1px solid rgba(0, 255, 255, 0.2);
    }

    .skeleton-label {
      height: 12px;
      width: 60%;
      margin-bottom: 16px;
    }

    .skeleton-value {
      height: 48px;
      width: 80%;
    }

    .skeleton-table-row {
      display: flex;
      gap: 20px;
      padding: 20px 28px;
      border-top: 1px solid rgba(48, 54, 61, 0.4);
    }

    .skeleton-cell {
      height: 20px;
      flex: 1;
    }

    .skeleton-cell-small {
      height: 20px;
      width: 80px;
    }

    /* Analytics Charts */
    .analytics-section {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .chart-card {
      background: rgba(30, 36, 44, 0.6);
      backdrop-filter: blur(10px);
      padding: 28px;
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.2);
    }

    .chart-title {
      font-size: 16px;
      font-weight: 700;
      color: #00FFFF;
      margin-bottom: 28px;
      letter-spacing: 1px;
      text-transform: uppercase;
      text-align: center;
    }

    .bar-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-around;
      height: 220px;
      padding: 20px 16px 0 16px;
      background: linear-gradient(180deg, rgba(13, 17, 23, 0.4) 0%, rgba(13, 17, 23, 0.2) 100%);
      border-radius: 12px;
      position: relative;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    /* Grid lines for visual reference */
    .bar-chart::before {
      content: '';
      position: absolute;
      top: 20px;
      left: 16px;
      right: 16px;
      bottom: 50px;
      background: repeating-linear-gradient(
        to bottom,
        transparent,
        transparent calc(25% - 1px),
        rgba(255, 255, 255, 0.04) calc(25% - 1px),
        rgba(255, 255, 255, 0.04) 25%
      );
      pointer-events: none;
    }

    .bar-wrapper {
      flex: 1;
      max-width: 70px;
      min-width: 36px;
      display: flex;
      flex-direction: column;
      align-items: center;
      height: 100%;
      position: relative;
      z-index: 1;
    }

    .bar-container {
      flex: 1;
      width: 100%;
      display: flex;
      flex-direction: column;
      justify-content: flex-end;
      align-items: center;
      padding-bottom: 8px;
    }

    .bar {
      width: 70%;
      max-width: 36px;
      min-width: 20px;
      background: linear-gradient(180deg, #00FFFF 0%, #0891b2 100%);
      border-radius: 4px 4px 2px 2px;
      transition: all 0.3s ease;
      min-height: 4px;
      box-shadow: 0 0 12px rgba(0, 255, 255, 0.3);
    }

    .bar:hover {
      background: linear-gradient(180deg, #22d3ee 0%, #00FFFF 100%);
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.5);
      transform: scaleX(1.1);
    }

    .bar-label-group {
      display: flex;
      flex-direction: column;
      align-items: center;
      padding: 10px 4px 8px 4px;
      border-top: 1px solid rgba(255, 255, 255, 0.08);
      width: 100%;
      background: rgba(13, 17, 23, 0.3);
      margin-top: auto;
      gap: 2px;
    }

    .bar-label {
      font-size: 12px;
      color: #9ca3af;
      font-weight: 600;
      text-align: center;
      white-space: nowrap;
    }

    .bar-value {
      font-size: 15px;
      font-weight: 700;
      color: #ffffff;
      text-align: center;
    }

    .category-chart {
      display: flex;
      flex-direction: column;
      gap: 12px;
      padding: 8px 0;
    }

    .category-item {
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      gap: 12px;
      padding: 8px 12px;
      background: rgba(13, 17, 23, 0.3);
      border-radius: 8px;
      border: 1px solid rgba(255, 255, 255, 0.04);
      transition: all 0.2s ease;
    }

    .category-item:hover {
      background: rgba(13, 17, 23, 0.5);
      border-color: rgba(0, 255, 255, 0.1);
    }

    .category-left {
      display: flex;
      align-items: center;
      gap: 10px;
      min-width: 110px;
    }

    .category-color {
      width: 10px;
      height: 10px;
      border-radius: 3px;
      flex-shrink: 0;
    }

    .category-name {
      font-size: 13px;
      font-weight: 600;
      color: #e6edf3;
      white-space: nowrap;
    }

    .category-bar-bg {
      height: 24px;
      background: rgba(30, 36, 44, 0.6);
      border-radius: 4px;
      position: relative;
      overflow: hidden;
      min-width: 60px;
    }

    .category-bar-fill {
      height: 100%;
      border-radius: 4px;
      transition: width 0.5s ease-out;
      display: flex;
      align-items: center;
      padding-left: 10px;
    }

    .category-count {
      font-size: 12px;
      font-weight: 700;
      color: #ffffff;
      text-shadow: 0 1px 3px rgba(0, 0, 0, 0.4);
      white-space: nowrap;
    }

    .category-percentage {
      font-size: 13px;
      font-weight: 700;
      color: #00FFFF;
      text-align: right;
      min-width: 48px;
    }

    /* Toast Notifications */
    .toast-container {
      position: fixed;
      top: 24px;
      right: 24px;
      z-index: 2000;
      display: flex;
      flex-direction: column;
      gap: 12px;
      max-width: 400px;
    }

    .toast {
      background: rgba(30, 36, 44, 0.98);
      backdrop-filter: blur(20px);
      border-radius: 12px;
      padding: 16px 20px;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.4);
      border: 1px solid;
      display: flex;
      align-items: center;
      gap: 12px;
      animation: slideInRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      min-width: 320px;
    }

    .toast.toast-success {
      border-color: rgba(16, 185, 129, 0.5);
      box-shadow: 0 8px 24px rgba(16, 185, 129, 0.2);
    }

    .toast.toast-error {
      border-color: rgba(239, 68, 68, 0.5);
      box-shadow: 0 8px 24px rgba(239, 68, 68, 0.2);
    }

    .toast.toast-info {
      border-color: rgba(0, 255, 255, 0.5);
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.2);
    }

    .toast-icon {
      flex-shrink: 0;
      width: 24px;
      height: 24px;
      display: flex;
      align-items: center;
      justify-content: center;
    }

    .toast-icon svg {
      width: 20px;
      height: 20px;
    }

    .toast-success .toast-icon {
      color: #10b981;
    }

    .toast-error .toast-icon {
      color: #ef4444;
    }

    .toast-info .toast-icon {
      color: #00FFFF;
    }

    .toast-message {
      flex: 1;
      font-size: 14px;
      font-weight: 600;
      color: #e6edf3;
      letter-spacing: 0.3px;
    }

    .toast-close {
      flex-shrink: 0;
      width: 20px;
      height: 20px;
      border: none;
      background: transparent;
      color: #9ca3af;
      cursor: pointer;
      padding: 0;
      display: flex;
      align-items: center;
      justify-content: center;
      transition: color 0.2s;
    }

    .toast-close:hover {
      color: #e6edf3;
    }

    @keyframes slideInRight {
      from {
        transform: translateX(400px);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    @keyframes slideOutRight {
      from {
        transform: translateX(0);
        opacity: 1;
      }
      to {
        transform: translateX(400px);
        opacity: 0;
      }
    }

    .toast.removing {
      animation: slideOutRight 0.3s cubic-bezier(0.4, 0, 0.2, 1);
    }

    /* Pagination */
    .pagination {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 24px 32px;
      border-top: 1px solid rgba(0, 255, 255, 0.2);
    }

    .pagination-info {
      font-size: 13px;
      color: #9ca3af;
      font-weight: 600;
      letter-spacing: 0.3px;
    }

    .pagination-controls {
      display: flex;
      gap: 8px;
      align-items: center;
    }

    .pagination-btn {
      padding: 8px 16px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.1), rgba(0, 200, 200, 0.1));
      color: #00FFFF;
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .pagination-btn:hover:not(:disabled) {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2));
      border-color: #00FFFF;
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.2);
    }

    .pagination-btn:disabled {
      opacity: 0.3;
      cursor: not-allowed;
      transform: none;
    }

    .page-numbers {
      display: flex;
      gap: 4px;
    }

    .page-number {
      padding: 8px 12px;
      background: transparent;
      color: #9ca3af;
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 6px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 40px;
      text-align: center;
    }

    .page-number:hover {
      background: rgba(0, 255, 255, 0.1);
      color: #e6edf3;
      border-color: rgba(0, 255, 255, 0.4);
    }

    .page-number.active {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.3), rgba(0, 200, 200, 0.3));
      color: #00FFFF;
      border-color: rgba(0, 255, 255, 0.5);
      box-shadow: 0 2px 8px rgba(0, 255, 255, 0.2);
    }

    .calls-section {
      background: rgba(30, 36, 44, 0.6);
      backdrop-filter: blur(10px);
      border-radius: 16px;
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.2);
      overflow: hidden;
    }

    .section-header {
      padding: 24px 32px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 16px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 700;
      color: #00FFFF;
      text-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
      letter-spacing: 1px;
    }

    .search-box {
      padding: 12px 18px;
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 14px;
      width: 300px;
      background: rgba(13, 17, 23, 0.8);
      color: #e6edf3;
      font-family: 'JetBrains Mono', monospace;
      transition: all 0.2s;
    }

    .search-box:focus {
      outline: none;
      border-color: #00FFFF;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    .search-box::placeholder {
      color: #6b7280;
    }

    .filters-row {
      display: flex;
      gap: 12px;
      align-items: center;
      flex-wrap: wrap;
    }

    .filter-select {
      padding: 12px 18px;
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 13px;
      background: rgba(13, 17, 23, 0.8);
      color: #e6edf3;
      font-family: 'JetBrains Mono', monospace;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
      min-width: 160px;
    }

    .quick-date-btn {
      padding: 10px 16px;
      border: 1px solid rgba(0, 255, 255, 0.4);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      background: rgba(0, 255, 255, 0.1);
      color: #00FFFF;
      cursor: pointer;
      transition: all 0.2s;
      white-space: nowrap;
      text-align: center;
    }

    .quick-date-btn:hover {
      background: rgba(0, 255, 255, 0.2);
      border-color: rgba(0, 255, 255, 0.6);
      transform: translateY(-1px);
    }

    .quick-date-btn:active {
      transform: translateY(0);
    }

    .filter-select:focus {
      outline: none;
      border-color: #00FFFF;
      box-shadow: 0 0 20px rgba(0, 255, 255, 0.3);
    }

    .filter-select option {
      background: #1e242c;
      color: #e6edf3;
    }

    .category-dropdown {
      position: absolute;
      top: 100%;
      left: 0;
      right: 0;
      margin-top: 8px;
      background: rgba(30, 36, 44, 0.98);
      backdrop-filter: blur(20px);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 12px;
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.2);
      z-index: 1000;
      min-width: 200px;
    }

    .category-dropdown label:hover {
      background: rgba(0, 255, 255, 0.1);
    }

    .multi-select-wrapper {
      position: relative;
      min-width: 180px;
    }

    .action-btn {
      padding: 12px 20px;
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.15), rgba(0, 200, 200, 0.15));
      color: #00FFFF;
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 8px;
      font-size: 13px;
      font-weight: 700;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 1px;
      display: flex;
      align-items: center;
      justify-content: center;
      gap: 8px;
      text-align: center;
    }

    .action-btn:hover {
      background: linear-gradient(135deg, rgba(0, 255, 255, 0.25), rgba(0, 200, 200, 0.25));
      border-color: #00FFFF;
      transform: translateY(-2px);
      box-shadow: 0 8px 20px rgba(0, 255, 255, 0.3);
    }

    .action-btn:active {
      transform: translateY(0);
    }

    .action-btn svg {
      width: 16px;
      height: 16px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    thead {
      background: rgba(13, 17, 23, 0.9);
    }

    th {
      text-align: left;
      padding: 18px 28px;
      font-size: 11px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      border-bottom: 2px solid rgba(0, 255, 255, 0.2);
    }

    td {
      padding: 20px 28px;
      border-top: 1px solid rgba(48, 54, 61, 0.4);
      font-size: 14px;
      font-weight: 500;
      color: #e6edf3;
      font-family: 'JetBrains Mono', monospace;
    }

    tbody tr {
      transition: all 0.2s ease;
    }

    tbody tr:hover {
      background: rgba(0, 255, 255, 0.08);
      cursor: pointer;
      transform: scale(1.001);
    }

    .status-badge {
      display: inline-block;
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
    }

    .status-completed {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.2);
    }

    .status-ongoing {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3), 0 0 20px rgba(245, 158, 11, 0.2);
    }

    .category-badge {
      display: inline-block;
      padding: 7px 16px;
      border-radius: 8px;
      font-size: 11px;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 1px;
      transition: all 0.2s;
    }

    .category-new-lead {
      background: linear-gradient(135deg, #10b981, #059669);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(16, 185, 129, 0.3), 0 0 20px rgba(16, 185, 129, 0.2);
    }

    .category-existing-client {
      background: linear-gradient(135deg, #3b82f6, #2563eb);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(59, 130, 246, 0.3), 0 0 20px rgba(59, 130, 246, 0.2);
    }

    .category-attorney {
      background: linear-gradient(135deg, #a855f7, #9333ea);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(168, 85, 247, 0.3), 0 0 20px rgba(168, 85, 247, 0.2);
    }

    .category-insurance {
      background: linear-gradient(135deg, #f59e0b, #d97706);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(245, 158, 11, 0.3), 0 0 20px rgba(245, 158, 11, 0.2);
    }

    .category-medical {
      background: linear-gradient(135deg, #ef4444, #dc2626);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(239, 68, 68, 0.3), 0 0 20px rgba(239, 68, 68, 0.2);
    }

    .category-other {
      background: linear-gradient(135deg, #6b7280, #4b5563);
      color: #ffffff;
      box-shadow: 0 2px 8px rgba(107, 114, 128, 0.3), 0 0 20px rgba(107, 114, 128, 0.2);
    }

    .category-uncategorized {
      background: linear-gradient(135deg, #374151, #1f2937);
      color: #9ca3af;
      box-shadow: 0 2px 8px rgba(55, 65, 81, 0.3);
    }

    .confidence-badge {
      display: inline-flex;
      align-items: center;
      padding: 6px 12px;
      border-radius: 6px;
      font-size: 11px;
      font-weight: 700;
      letter-spacing: 0.5px;
      border: 1.5px solid;
      transition: all 0.2s;
      cursor: help;
    }

    .confidence-badge:hover {
      transform: translateY(-1px);
      box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
    }

    .confidence-na {
      color: #6b7280;
      border-color: #6b7280;
      background: rgba(107, 114, 128, 0.1);
    }

    .modal {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      background-color: rgba(0, 0, 0, 0.5);
      overflow-y: auto;
    }

    .modal-content {
      background: rgba(30, 36, 44, 0.98);
      backdrop-filter: blur(20px);
      margin: 5% auto;
      padding: 0;
      border-radius: 16px;
      width: 90%;
      max-width: 900px;
      box-shadow: 0 20px 60px rgba(0, 255, 255, 0.3);
      border: 1px solid rgba(0, 255, 255, 0.3);
    }

    .modal-header {
      padding: 24px 32px;
      border-bottom: 1px solid rgba(0, 255, 255, 0.2);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .modal-header h2 {
      font-size: 20px;
      font-weight: 700;
      color: #00FFFF;
      text-shadow: 0 0 15px rgba(0, 255, 255, 0.4);
      letter-spacing: 1px;
    }

    .close {
      font-size: 32px;
      font-weight: 300;
      color: #9ca3af;
      cursor: pointer;
      line-height: 1;
      transition: all 0.2s;
    }

    .close:hover {
      color: #00FFFF;
      text-shadow: 0 0 15px rgba(0, 255, 255, 0.6);
    }

    .modal-body {
      padding: 32px;
      max-height: 70vh;
      overflow-y: auto;
    }

    .field-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    .field {
      padding: 18px;
      background: rgba(13, 17, 23, 0.6);
      border-radius: 10px;
      border: 1px solid rgba(0, 255, 255, 0.1);
    }

    .field-label {
      font-size: 11px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 8px;
    }

    .field-value {
      font-size: 15px;
      font-weight: 500;
      color: #e6edf3;
      font-family: 'JetBrains Mono', monospace;
    }

    .transcript-section {
      margin-top: 24px;
    }

    .transcript-title {
      font-size: 16px;
      font-weight: 700;
      color: #00FFFF;
      margin-bottom: 16px;
      letter-spacing: 1px;
    }

    .transcript-box {
      background: rgba(13, 17, 23, 0.6);
      border: 1px solid rgba(0, 255, 255, 0.2);
      border-radius: 10px;
      padding: 20px;
      max-height: 400px;
      overflow-y: auto;
    }

    .transcript-message {
      margin-bottom: 16px;
      padding: 14px;
      border-radius: 8px;
    }

    .transcript-user {
      background: rgba(102, 126, 234, 0.1);
      border-left: 3px solid #667eea;
    }

    .transcript-agent {
      background: rgba(72, 187, 120, 0.1);
      border-left: 3px solid #48bb78;
    }

    .transcript-role {
      font-size: 10px;
      font-weight: 700;
      color: #9ca3af;
      text-transform: uppercase;
      letter-spacing: 1.5px;
      margin-bottom: 6px;
    }

    .audio-section {
      margin-top: 24px;
    }

    audio {
      width: 100%;
      border-radius: 8px;
    }


    /* Landscape mobile devices */
    @media (max-width: 768px) and (orientation: landscape) {
      .stats-grid {
        grid-template-columns: repeat(4, 1fr);
      }

      .analytics-section {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    /* Touch device improvements */
    @media (hover: none) and (pointer: coarse) {
      /* Larger touch targets */
      button, a, .action-btn, .filter-select, input, select {
        min-height: 44px;
        min-width: 44px;
      }

      /* Remove hover effects on touch devices */
      .stat-card:hover,
      .action-btn:hover,
      .logout-btn:hover {
        transform: none;
      }

      /* Show tap feedback instead */
      .stat-card:active,
      .action-btn:active,
      .logout-btn:active {
        transform: scale(0.98);
        opacity: 0.9;
      }
    }

    /* Enhanced Mobile Optimizations for iPhone and smaller devices */
    @media (max-width: 768px) {
      /* Improve overall spacing and layout */
      body {
        font-size: 14px;
        line-height: 1.5;
      }

      .container {
        padding: 16px;
        max-width: 100%;
      }

      .dashboard-card {
        padding: 20px;
        margin-bottom: 20px;
        border-radius: 12px;
      }

      /* Header improvements */
      .header {
        padding: 16px;
        gap: 12px;
        flex-direction: column;
        align-items: stretch;
      }

      .header > div:first-child {
        flex-direction: row !important;
        justify-content: flex-start;
        gap: 12px !important;
      }

      .header > div:first-child img {
        height: 36px !important;
      }

      .header h1 {
        font-size: 20px;
        line-height: 1.2;
        text-align: left;
      }

      .business-name {
        font-size: 11px;
        margin-top: 2px;
        text-align: left;
      }

      .header > div:last-child {
        display: flex;
        gap: 8px;
      }

      .logout-btn {
        flex: 1;
        padding: 12px;
        font-size: 13px;
        text-align: center;
      }

      /* Stats grid - 2 columns on mobile */
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
        gap: 12px;
      }

      .stat-card {
        padding: 16px;
        text-align: center;
      }

      .stat-value {
        font-size: 28px;
      }

      .stat-label {
        font-size: 11px;
        margin-top: 4px;
        opacity: 0.9;
      }

      /* Tab navigation */
      .tab-nav {
        display: flex;
        gap: 6px;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin-bottom: 16px;
        padding-bottom: 4px;
      }

      .tab-button {
        padding: 10px 16px;
        font-size: 13px;
        white-space: nowrap;
        min-width: auto;
      }

      /* Filters section improvements */
      .filters-row {
        flex-direction: column;
        gap: 16px;
      }

      .filter-select,
      .search-box {
        width: 100%;
        min-width: unset;
        font-size: 14px;
        padding: 14px;
      }

      /* Quick date buttons - stack on mobile */
      .quick-date-btn {
        flex: 1;
        min-width: 0;
        padding: 13px 12px;
        font-size: 13px;
      }

      /* Date inputs */
      input[type="date"] {
        padding: 14px;
        font-size: 14px;
      }

      /* Filter labels */
      .filters-row label {
        font-size: 10px;
        margin-bottom: 6px;
      }

      /* Section headers */
      .section-header {
        flex-direction: column;
        gap: 16px;
        align-items: stretch;
      }

      .section-title {
        font-size: 18px;
        text-align: center;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        font-weight: 600;
      }

      .section-header h2 {
        font-size: 19px;
        text-align: center;
      }

      /* Action buttons */
      .action-btn {
        width: 100%;
        padding: 12px 16px;
        font-size: 13px;
        justify-content: center;
      }

      /* Charts improvements - Professional mobile design */
      .analytics-section {
        grid-template-columns: 1fr;
        gap: 16px;
      }

      .chart-card {
        padding: 20px 14px;
        border-radius: 12px;
        overflow: visible;
      }

      .chart-title {
        font-size: 13px;
        margin-bottom: 16px;
        padding-bottom: 10px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        text-align: center;
        line-height: 1.4;
        font-weight: 600;
        letter-spacing: 0.5px;
      }

      .bar-chart {
        height: 180px;
        padding: 16px 8px 0 8px;
        justify-content: space-around;
        background: linear-gradient(180deg, rgba(13, 17, 23, 0.4) 0%, rgba(13, 17, 23, 0.2) 100%);
        border-radius: 10px;
        border: 1px solid rgba(255, 255, 255, 0.05);
      }

      .bar-chart::before {
        top: 16px;
        left: 8px;
        right: 8px;
        bottom: 44px;
      }

      .bar-wrapper {
        min-width: 32px;
        max-width: 50px;
      }

      .bar-container {
        padding-bottom: 6px;
      }

      .bar {
        width: 80%;
        max-width: 28px;
        min-width: 16px;
        border-radius: 3px 3px 1px 1px;
      }

      .bar-label-group {
        padding: 8px 2px 6px 2px;
        gap: 1px;
      }

      .bar-label {
        font-size: 11px;
      }

      .bar-value {
        font-size: 13px;
      }

      /* Category breakdown - mobile optimized */
      .category-chart {
        gap: 8px;
        padding: 4px 0;
      }

      .category-item {
        grid-template-columns: auto 1fr auto;
        gap: 8px;
        padding: 6px 10px;
      }

      .category-left {
        min-width: 90px;
        gap: 8px;
      }

      .category-color {
        width: 8px;
        height: 8px;
        border-radius: 2px;
      }

      .category-name {
        font-size: 11px;
      }

      .category-bar-bg {
        height: 20px;
        min-width: 40px;
      }

      .category-bar-fill {
        padding-left: 6px;
      }

      .category-count {
        font-size: 10px;
      }

      .category-percentage {
        font-size: 11px;
        min-width: 40px;
      }

      /* Table wrapper with better scroll */
      .calls-section {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px;
        padding: 0 16px;
      }

      table {
        font-size: 12px;
        min-width: 650px;
      }

      th {
        padding: 12px 10px;
        font-size: 11px;
        white-space: nowrap;
      }

      td {
        padding: 14px 10px;
        font-size: 12px;
      }

      /* Pagination improvements */
      .pagination {
        flex-wrap: wrap;
        gap: 10px;
        padding: 16px 0;
      }

      .pagination button {
        padding: 10px 14px;
        font-size: 13px;
        min-height: 44px;
      }

      .page-numbers {
        display: flex;
        gap: 6px;
        flex-wrap: wrap;
      }

      .pagination-info {
        font-size: 12px;
        width: 100%;
        text-align: center;
        order: -1;
      }

      /* Modal improvements */
      .modal-content {
        margin: 16px;
        max-width: calc(100% - 32px);
        max-height: calc(100vh - 32px);
        padding: 20px 16px;
        overflow-y: auto;
      }

      .modal h2 {
        font-size: 18px;
        margin-bottom: 16px;
      }

      .close-modal {
        top: 12px;
        right: 12px;
        width: 32px;
        height: 32px;
        font-size: 24px;
      }

      /* Settings modal - full screen on mobile */
      #settings-modal .modal-content {
        margin: 0;
        max-width: 100%;
        width: 100%;
        height: 100vh;
        max-height: 100vh;
        border-radius: 0;
        display: flex;
        flex-direction: column;
      }

      #settings-modal .modal-header {
        flex-shrink: 0;
      }

      #settings-modal .modal-body {
        flex: 1;
        overflow-y: auto;
        padding-bottom: 20px;
      }

      /* Settings modal tabs - horizontal scroll on mobile */
      #settings-modal .modal-body > div:first-child {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px 24px -16px;
        padding: 0 16px;
        display: flex;
        gap: 8px;
        position: relative;
      }

      /* Fade indicator for more tabs */
      #settings-modal .modal-body > div:first-child::after {
        content: '';
        position: sticky;
        right: 0;
        top: 0;
        bottom: 0;
        width: 30px;
        background: linear-gradient(to right, transparent, rgba(30, 36, 44, 0.98));
        pointer-events: none;
        flex-shrink: 0;
      }

      .settings-tab {
        padding: 10px 14px !important;
        font-size: 12px !important;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* Quick filters - center on mobile */
      #recent-calls-section .filters-row > div:first-child {
        align-items: center;
        text-align: center;
      }

      #recent-calls-section .filters-row > div:first-child > label {
        text-align: center;
        width: 100%;
      }

      #recent-calls-section .filters-row > div:first-child > div {
        justify-content: center;
      }

      /* Form fields in modals */
      .field-grid {
        grid-template-columns: 1fr;
        gap: 12px;
      }

      .form-field label {
        font-size: 12px;
        margin-bottom: 6px;
      }

      .form-field input,
      .form-field select,
      .form-field textarea {
        font-size: 14px;
        padding: 12px;
      }

      /* Lead Tracker - Mobile Optimized */
      #lead-tracker-section .section-header {
        flex-direction: column;
        gap: 12px;
        align-items: stretch;
      }

      #lead-tracker-section .section-header > div {
        justify-content: center;
      }

      /* Leads tabs - horizontal scroll on mobile */
      #lead-tracker-section > div:nth-child(4) {
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        margin: 0 -16px 20px -16px;
        padding: 0 16px;
        scrollbar-width: none;
      }

      #lead-tracker-section > div:nth-child(4)::-webkit-scrollbar {
        display: none;
      }

      .leads-tab {
        padding: 10px 16px;
        font-size: 13px;
        white-space: nowrap;
        flex-shrink: 0;
      }

      /* Lead table - card style on mobile */
      #leads-pending-container table,
      #leads-approved-container table,
      #leads-denied-container table {
        display: block;
        min-width: unset;
      }

      #leads-pending-container thead,
      #leads-approved-container thead,
      #leads-denied-container thead {
        display: none;
      }

      #leads-pending-container tbody,
      #leads-approved-container tbody,
      #leads-denied-container tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
      }

      #leads-pending-container tbody tr,
      #leads-approved-container tbody tr,
      #leads-denied-container tbody tr {
        display: flex;
        flex-direction: column;
        background: rgba(30, 36, 44, 0.6);
        border: 1px solid rgba(48, 54, 61, 0.8);
        border-radius: 12px;
        padding: 16px;
        gap: 8px;
      }

      #leads-pending-container tbody tr:hover,
      #leads-approved-container tbody tr:hover,
      #leads-denied-container tbody tr:hover {
        border-color: rgba(0, 255, 255, 0.3);
      }

      #leads-pending-container tbody td,
      #leads-approved-container tbody td,
      #leads-denied-container tbody td {
        padding: 0;
        border: none;
        background: transparent;
      }

      /* Name - larger and bold */
      #leads-pending-container tbody td:first-child,
      #leads-approved-container tbody td:first-child,
      #leads-denied-container tbody td:first-child {
        font-size: 16px;
        font-weight: 600;
        color: #e6edf3;
        margin-bottom: 4px;
      }

      /* Phone */
      #leads-pending-container tbody td:nth-child(2),
      #leads-approved-container tbody td:nth-child(2),
      #leads-denied-container tbody td:nth-child(2) {
        color: #00FFFF !important;
        font-size: 14px !important;
      }

      /* Actions - full width buttons */
      #leads-pending-container tbody td:last-child,
      #leads-approved-container tbody td:last-child,
      #leads-denied-container tbody td:last-child {
        display: flex;
        gap: 8px;
        margin-top: 8px;
        padding-top: 12px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
      }

      #leads-pending-container .btn-approve,
      #leads-pending-container .btn-deny {
        flex: 1;
        padding: 12px 8px !important;
        font-size: 12px !important;
        margin: 0 !important;
      }

      /* Lead tracker table fallback */
      .lead-tracker-table {
        font-size: 12px;
        min-width: 700px;
      }

      .lead-tracker-table th {
        padding: 10px 8px;
        font-size: 11px;
      }

      .lead-tracker-table td {
        padding: 12px 8px;
        font-size: 12px;
      }

      /* Status badges */
      .status-badge {
        padding: 5px 10px;
        font-size: 10px;
      }

      /* Scrollbar styling for mobile */
      ::-webkit-scrollbar {
        height: 6px;
      }

      ::-webkit-scrollbar-track {
        background: rgba(255, 255, 255, 0.05);
        border-radius: 3px;
      }

      ::-webkit-scrollbar-thumb {
        background: rgba(0, 255, 255, 0.3);
        border-radius: 3px;
      }

      /* Recent Calls Table - Card Layout on Mobile */
      #recent-calls-section #calls-table {
        min-width: unset;
        width: 100%;
      }

      #recent-calls-section #calls-table thead {
        display: none;
      }

      #recent-calls-section #calls-table tbody {
        display: flex;
        flex-direction: column;
        gap: 12px;
        padding: 16px;
      }

      #recent-calls-section #calls-table tbody tr {
        display: flex;
        flex-direction: column;
        background: rgba(30, 36, 44, 0.6);
        border: 1px solid rgba(48, 54, 61, 0.8);
        border-radius: 12px;
        padding: 16px;
        gap: 8px;
        cursor: pointer;
        transition: all 0.2s ease;
      }

      #recent-calls-section #calls-table tbody tr:hover {
        background: rgba(30, 36, 44, 0.8);
        border-color: rgba(0, 255, 255, 0.3);
      }

      #recent-calls-section #calls-table tbody td {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 4px 0;
        border: none;
        background: transparent;
      }

      #recent-calls-section #calls-table tbody td::before {
        content: attr(data-label);
        font-size: 11px;
        font-weight: 600;
        color: #7d8590;
        text-transform: uppercase;
        letter-spacing: 0.5px;
      }

      /* Phone number - prominent */
      #recent-calls-section #calls-table tbody td:first-child {
        font-size: 15px;
        font-weight: 600;
        color: #00FFFF;
        padding-bottom: 8px;
        border-bottom: 1px solid rgba(255, 255, 255, 0.08);
        margin-bottom: 4px;
      }

      #recent-calls-section #calls-table tbody td:first-child::before {
        display: none;
      }

      /* Category badge styling */
      #recent-calls-section #calls-table tbody td:last-child {
        padding-top: 8px;
        border-top: 1px solid rgba(255, 255, 255, 0.08);
        margin-top: 4px;
      }

      /* Quick Filters - horizontal scroll on mobile */
      #recent-calls-section .filters-row > div:first-child > div:last-child {
        display: flex;
        overflow-x: auto;
        -webkit-overflow-scrolling: touch;
        scrollbar-width: none;
        gap: 8px;
        padding-bottom: 4px;
      }

      #recent-calls-section .filters-row > div:first-child > div:last-child::-webkit-scrollbar {
        display: none;
      }
    }

    /* Extra optimizations for very small phones (< 375px) */
    @media (max-width: 374px) {
      .header h1 {
        font-size: 18px;
      }

      .stat-value {
        font-size: 24px;
      }

      .tab-button {
        padding: 8px 12px;
        font-size: 12px;
      }

      .quick-date-btn {
        padding: 10px 8px;
        font-size: 11px;
      }

      .action-btn {
        padding: 10px 12px;
        font-size: 12px;
      }

      table {
        font-size: 11px;
      }

      th, td {
        padding: 10px 6px;
      }
    }

    /* Tooltip Styles */
    .tooltip-icon {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 16px;
      height: 16px;
      margin-left: 6px;
      font-size: 11px;
      font-weight: 700;
      color: #9ca3af;
      background: rgba(0, 255, 255, 0.1);
      border: 1px solid rgba(0, 255, 255, 0.3);
      border-radius: 50%;
      cursor: help;
      transition: all 0.2s;
      position: relative;
    }

    .tooltip-icon:hover {
      color: #00FFFF;
      background: rgba(0, 255, 255, 0.2);
      border-color: #00FFFF;
      transform: scale(1.1);
    }

    .tooltip-text {
      visibility: hidden;
      opacity: 0;
      position: absolute;
      z-index: 1000;
      bottom: 125%;
      left: 50%;
      transform: translateX(-50%);
      background: rgba(13, 17, 23, 0.98);
      border: 1px solid rgba(0, 255, 255, 0.4);
      color: #e6edf3;
      padding: 10px 14px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      white-space: nowrap;
      box-shadow: 0 8px 24px rgba(0, 255, 255, 0.2);
      transition: all 0.2s;
      pointer-events: none;
      line-height: 1.4;
      max-width: calc(100vw - 40px);
    }

    .tooltip-text::after {
      content: '';
      position: absolute;
      top: 100%;
      left: 50%;
      transform: translateX(-50%);
      border: 6px solid transparent;
      border-top-color: rgba(0, 255, 255, 0.4);
    }

    .tooltip-icon:hover .tooltip-text {
      visibility: visible;
      opacity: 1;
      bottom: 150%;
    }

    /* For tooltips that need to wrap text */
    .tooltip-text.wrap {
      white-space: normal;
      max-width: 250px;
      text-align: center;
    }

    /* Leads Tabs */
    .leads-tab {
      padding: 12px 24px;
      background: transparent;
      color: #7d8590;
      border: none;
      border-bottom: 3px solid transparent;
      cursor: pointer;
      font-size: 14px;
      font-weight: 600;
      transition: all 0.2s ease;
    }

    .leads-tab:hover {
      color: #00FFFF;
      background: rgba(0, 255, 255, 0.05);
    }

    .leads-tab.active {
      color: #00FFFF;
      border-bottom-color: #00FFFF;
    }

    .leads-tab-content {
      animation: fadeIn 0.3s ease;
    }

    @keyframes fadeIn {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }

    @keyframes pulse {
      0%, 100% {
        border-color: #00FFFF;
        box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.85), 0 0 40px rgba(0, 255, 255, 0.6);
      }
      50% {
        border-color: #00CCCC;
        box-shadow: 0 0 0 5000px rgba(0, 0, 0, 0.85), 0 0 60px rgba(0, 255, 255, 0.9);
      }
    }

    @keyframes bounce {
      0%, 100% { transform: translateY(0); }
      50% { transform: translateY(-10px); }
    }

    /* Lead Card for better mobile view */
    .lead-card {
      background: rgba(30, 36, 44, 0.6);
      border: 1px solid rgba(48, 54, 61, 0.8);
      border-radius: 8px;
      padding: 16px;
      margin-bottom: 12px;
      transition: all 0.2s ease;
    }

    .lead-card:hover {
      border-color: rgba(0, 255, 255, 0.4);
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.1);
    }

    .lead-card-header {
      display: flex;
      justify-content: space-between;
      align-items: start;
      margin-bottom: 12px;
    }

    .lead-card-name {
      font-size: 16px;
      font-weight: 600;
      color: #e6edf3;
    }

    .lead-card-phone {
      color: #00FFFF;
      font-family: 'JetBrains Mono', monospace;
      font-size: 13px;
    }

    .lead-card-summary {
      color: #9ca3af;
      font-size: 13px;
      line-height: 1.5;
      margin: 12px 0;
      padding: 12px;
      background: rgba(13, 17, 23, 0.4);
      border-radius: 6px;
      border-left: 3px solid rgba(0, 255, 255, 0.3);
    }

    .lead-card-actions {
      display: flex;
      gap: 8px;
      margin-top: 12px;
    }

    .btn-approve, .btn-deny {
      flex: 1;
      padding: 12px 18px;
      border: none;
      border-radius: 8px;
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
      text-transform: uppercase;
      letter-spacing: 0.5px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
      display: inline-flex;
      align-items: center;
      justify-content: center;
      gap: 6px;
      text-align: center;
    }

    .btn-approve {
      background: linear-gradient(135deg, rgba(0, 255, 0, 0.15) 0%, rgba(0, 200, 0, 0.1) 100%);
      color: #00FF00;
      border: 1.5px solid rgba(0, 255, 0, 0.4);
    }

    .btn-approve:hover {
      background: linear-gradient(135deg, rgba(0, 255, 0, 0.25) 0%, rgba(0, 200, 0, 0.15) 100%);
      border-color: rgba(0, 255, 0, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(0, 255, 0, 0.3);
    }

    .btn-approve:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(0, 255, 0, 0.2);
    }

    .btn-deny {
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.15) 0%, rgba(200, 0, 0, 0.1) 100%);
      color: #FF4444;
      border: 1.5px solid rgba(255, 0, 0, 0.4);
    }

    .btn-deny:hover {
      background: linear-gradient(135deg, rgba(255, 0, 0, 0.25) 0%, rgba(200, 0, 0, 0.15) 100%);
      border-color: rgba(255, 0, 0, 0.6);
      transform: translateY(-2px);
      box-shadow: 0 4px 12px rgba(255, 0, 0, 0.3);
    }

    .btn-deny:active {
      transform: translateY(0);
      box-shadow: 0 2px 6px rgba(255, 0, 0, 0.2);
    }

    /* Mobile optimizations for buttons */
    @media (max-width: 768px) {
      .btn-approve, .btn-deny {
        padding: 16px 20px;
        font-size: 13px;
        min-height: 50px;
        font-weight: 700;
        border-width: 2px;
      }

      /* Make buttons stack vertically on very small screens in tables */
      td .btn-approve,
      td .btn-deny {
        display: flex;
        justify-content: center;
        align-items: center;
        width: 100%;
        margin-bottom: 8px;
        text-align: center;
      }

      td .btn-deny {
        margin-bottom: 0;
      }
    }

    /* ============================================
       PREMIUM THEME OVERRIDE
       Clean, Minimal, Professional
       ============================================ */

    :root {
      --bg-primary: #09090b;
      --bg-secondary: #18181b;
      --bg-tertiary: #27272a;
      --border-subtle: rgba(255, 255, 255, 0.06);
      --border-default: rgba(255, 255, 255, 0.1);
      --text-primary: #fafafa;
      --text-secondary: #a1a1aa;
      --text-tertiary: #71717a;
      --accent: #00FFFF;
      --accent-subtle: rgba(0, 255, 255, 0.1);
      --shadow-md: 0 4px 12px rgba(0, 0, 0, 0.4);
      --shadow-lg: 0 8px 30px rgba(0, 0, 0, 0.5);
      --radius-md: 10px;
      --radius-lg: 14px;
    }

    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, system-ui, sans-serif !important;
      background: var(--bg-primary) !important;
      -webkit-font-smoothing: antialiased;
    }

    .header {
      background: var(--bg-secondary) !important;
      border-bottom: 1px solid var(--border-subtle) !important;
      box-shadow: var(--shadow-md) !important;
    }

    .header h1 {
      font-family: 'Inter', sans-serif !important;
      font-size: 24px !important;
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      text-shadow: none !important;
      letter-spacing: -0.02em !important;
    }

    .business-name {
      font-family: 'Inter', sans-serif !important;
      color: var(--text-tertiary) !important;
    }

    .logout-btn {
      font-family: 'Inter', sans-serif !important;
      border-radius: var(--radius-md) !important;
    }

    .stat-card, .chart-card, .skeleton-stat-card {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-subtle) !important;
      box-shadow: var(--shadow-md) !important;
      border-radius: var(--radius-lg) !important;
      backdrop-filter: none !important;
    }

    .stat-card:hover, .chart-card:hover {
      border-color: var(--border-default) !important;
      box-shadow: var(--shadow-lg) !important;
      transform: translateY(-2px) !important;
    }

    /* Professional subtle effects */
    .header {
      box-shadow: var(--shadow-md) !important;
    }

    .bar {
      box-shadow: 0 1px 4px rgba(0, 255, 255, 0.15) !important;
    }

    .bar:hover {
      box-shadow: 0 4px 12px rgba(0, 255, 255, 0.25) !important;
    }

    .stat-label, .chart-title {
      font-family: 'Inter', sans-serif !important;
      color: var(--text-tertiary) !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      letter-spacing: 0.05em !important;
      text-shadow: none !important;
    }

    .stat-value {
      font-family: 'Inter', sans-serif !important;
      font-size: 32px !important;
      font-weight: 600 !important;
      color: var(--text-primary) !important;
      text-shadow: none !important;
      letter-spacing: -0.02em !important;
    }

    .calls-table {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-subtle) !important;
      box-shadow: var(--shadow-md) !important;
      border-radius: var(--radius-lg) !important;
      backdrop-filter: none !important;
    }

    /* Remove cyan accents from line under header */
    .header::after {
      display: none !important;
    }

    .table-header {
      background: var(--bg-primary) !important;
      border-bottom: 1px solid var(--border-subtle) !important;
    }

    .table-title {
      font-family: 'Inter', sans-serif !important;
      color: var(--text-primary) !important;
      font-size: 16px !important;
      font-weight: 600 !important;
      text-shadow: none !important;
      letter-spacing: -0.01em !important;
    }

    th {
      font-family: 'Inter', sans-serif !important;
      background: var(--bg-primary) !important;
      color: var(--text-tertiary) !important;
      font-size: 12px !important;
      font-weight: 500 !important;
      letter-spacing: 0.05em !important;
      border-bottom: 1px solid var(--border-subtle) !important;
    }

    td {
      font-family: 'Inter', sans-serif !important;
      color: var(--text-primary) !important;
      border-top: 1px solid var(--border-subtle) !important;
    }

    tr:hover {
      background: rgba(255, 255, 255, 0.02) !important;
    }

    .search-box {
      font-family: 'Inter', sans-serif !important;
      background: var(--bg-primary) !important;
      border: 1px solid var(--border-default) !important;
      border-radius: var(--radius-md) !important;
    }

    .search-box:focus {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 3px var(--accent-subtle) !important;
    }

    /* Modal styling */
    .modal-content {
      background: var(--bg-secondary) !important;
      border: 1px solid var(--border-default) !important;
      border-radius: var(--radius-lg) !important;
      box-shadow: var(--shadow-lg) !important;
    }

    .modal-header {
      border-bottom: 1px solid var(--border-subtle) !important;
    }

    .modal-header h3 {
      font-family: 'Inter', sans-serif !important;
      color: var(--text-primary) !important;
      text-shadow: none !important;
    }

    /* Input fields */
    input[type="text"],
    input[type="email"],
    input[type="password"],
    input[type="tel"],
    input[type="date"],
    select,
    textarea {
      font-family: 'Inter', sans-serif !important;
      background: var(--bg-primary) !important;
      border: 1px solid var(--border-default) !important;
      border-radius: var(--radius-md) !important;
      color: var(--text-primary) !important;
    }

    input:focus,
    select:focus,
    textarea:focus {
      border-color: var(--accent) !important;
      box-shadow: 0 0 0 3px var(--accent-subtle) !important;
      outline: none !important;
    }

    /* Buttons */
    button {
      font-family: 'Inter', sans-serif !important;
    }

    /* Filter buttons */
    .filter-btn {
      font-family: 'Inter', sans-serif !important;
      background: var(--bg-primary) !important;
      border: 1px solid var(--border-default) !important;
      border-radius: var(--radius-md) !important;
      color: var(--text-secondary) !important;
    }

    .filter-btn:hover,
    .filter-btn.active {
      border-color: var(--accent) !important;
      color: var(--accent) !important;
      background: var(--accent-subtle) !important;
    }

    /* Scrollbar */
    ::-webkit-scrollbar {
      width: 10px;
      height: 10px;
    }

    ::-webkit-scrollbar-track {
      background: rgba(255, 255, 255, 0.05);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb {
      background: rgba(255, 255, 255, 0.2);
      border-radius: 5px;
    }

    ::-webkit-scrollbar-thumb:hover {
      background: rgba(255, 255, 255, 0.3);
    }
  </style>
</head>
<body>
  <!-- Toast Container -->
  <div class="toast-container" id="toast-container"></div>

  <div class="header">
    <div style="display: flex; align-items: center; gap: 16px;">
      <img src="https://storage.googleapis.com/msgsndr/lneM3M1j3P5i0JYeNK18/media/68bcea80938a4e0fd2da0e79.png" alt="SaveYa Logo" style="height: 48px; width: auto;">
      <div>
        <h1>Dashboard</h1>
        <div class="business-name" id="business-name">Loading...</div>
      </div>
    </div>
    <div style="display: flex; gap: 12px;">
      <button class="logout-btn" onclick="openSettings()" style="background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3);">
        <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px; display: inline-block; margin-right: 6px; vertical-align: middle;">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.325 4.317c.426-1.756 2.924-1.756 3.35 0a1.724 1.724 0 002.573 1.066c1.543-.94 3.31.826 2.37 2.37a1.724 1.724 0 001.065 2.572c1.756.426 1.756 2.924 0 3.35a1.724 1.724 0 00-1.066 2.573c.94 1.543-.826 3.31-2.37 2.37a1.724 1.724 0 00-2.572 1.065c-.426 1.756-2.924 1.756-3.35 0a1.724 1.724 0 00-2.573-1.066c-1.543.94-3.31-.826-2.37-2.37a1.724 1.724 0 00-1.065-2.572c-1.756-.426-1.756-2.924 0-3.35a1.724 1.724 0 001.066-2.573c-.94-1.543.826-3.31 2.37-2.37.996.608 2.296.07 2.572-1.065z"></path>
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12a3 3 0 11-6 0 3 3 0 016 0z"></path>
        </svg>
        Settings
      </button>
      <button class="logout-btn" onclick="logout()">Logout</button>
    </div>
  </div>

  <div class="container">
    <div id="loading" style="display: block;">
      <!-- Skeleton Stats Grid -->
      <div class="stats-grid">
        <div class="skeleton-stat-card">
          <div class="skeleton skeleton-label"></div>
          <div class="skeleton skeleton-value"></div>
        </div>
        <div class="skeleton-stat-card">
          <div class="skeleton skeleton-label"></div>
          <div class="skeleton skeleton-value"></div>
        </div>
        <div class="skeleton-stat-card">
          <div class="skeleton skeleton-label"></div>
          <div class="skeleton skeleton-value"></div>
        </div>
        <div class="skeleton-stat-card">
          <div class="skeleton skeleton-label"></div>
          <div class="skeleton skeleton-value"></div>
        </div>
      </div>

      <!-- Skeleton Table -->
      <div class="calls-section" style="margin-top: 32px;">
        <div class="section-header">
          <div class="skeleton" style="height: 24px; width: 150px;"></div>
        </div>
        <div>
          <div class="skeleton-table-row">
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
          </div>
          <div class="skeleton-table-row">
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
          </div>
          <div class="skeleton-table-row">
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
          </div>
          <div class="skeleton-table-row">
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
            <div class="skeleton skeleton-cell-small"></div>
          </div>
        </div>
      </div>
    </div>

    <div id="dashboard-content" style="display: none;">
      <div class="stats-grid">
        <div class="stat-card">
          <div class="stat-label">
            Total Calls
            <span class="tooltip-icon">?
              <span class="tooltip-text">Total number of calls received by your AI receptionist</span>
            </span>
          </div>
          <div class="stat-value" id="total-calls">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">
            New Leads
            <span class="tooltip-icon">?
              <span class="tooltip-text">Calls categorized as potential new business opportunities</span>
            </span>
          </div>
          <div class="stat-value" id="new-leads">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">
            Existing Clients
            <span class="tooltip-icon">?
              <span class="tooltip-text">Calls from known clients or repeat callers</span>
            </span>
          </div>
          <div class="stat-value" id="existing-clients">0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">
            Other Calls
            <span class="tooltip-icon">?
              <span class="tooltip-text wrap">Calls from attorneys, insurance, medical providers, or uncategorized</span>
            </span>
          </div>
          <div class="stat-value" id="other-calls">0</div>
        </div>
      </div>

      <!-- Analytics Charts -->
      <div id="analytics-section" class="analytics-section">
        <div class="chart-card">
          <div class="chart-title">Calls Over Time (Last 7 Days)</div>
          <div id="calls-over-time-chart" class="bar-chart"></div>
        </div>

        <div class="chart-card">
          <div class="chart-title">Category Distribution</div>
          <div id="category-distribution-chart" class="category-chart"></div>
        </div>
      </div>

      <!-- Lead Tracking Section -->
      <div id="lead-tracker-section" class="calls-section" style="margin-bottom: 32px;">
        <div class="section-header">
          <div class="section-title">Lead Tracker</div>
          <div style="display: flex; gap: 12px;">
            <button class="action-btn" onclick="loadClientLeads()" style="position: relative;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Refresh
            </button>
            <button class="action-btn" id="export-leads-btn" onclick="exportApprovedLeadsClient()" style="display: none; position: relative;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Export Approved Leads
            </button>
          </div>
        </div>

        <!-- Leads Stats -->
        <div class="stats-grid" style="margin-bottom: 24px;">
          <div class="stat-card">
            <div class="stat-label">Total Leads</div>
            <div class="stat-value" id="leads-total">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Approved</div>
            <div class="stat-value" id="leads-approved" style="color: #00FF00;">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Denied</div>
            <div class="stat-value" id="leads-denied" style="color: #FF0000;">0</div>
          </div>
          <div class="stat-card">
            <div class="stat-label">Conversion Rate</div>
            <div class="stat-value" id="leads-conversion-rate">0%</div>
          </div>
        </div>

        <!-- Search Bar -->
        <div style="margin-bottom: 20px;">
          <div style="position: relative; max-width: 500px;">
            <svg style="position: absolute; left: 14px; top: 50%; transform: translateY(-50%); width: 18px; height: 18px; color: #6b7280;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path>
            </svg>
            <input
              type="text"
              id="leads-search-input"
              placeholder="Search leads by name, phone, or email..."
              oninput="handleLeadsSearch(this.value)"
              style="
                width: 100%;
                padding: 12px 44px 12px 44px;
                background: rgba(13, 17, 23, 0.6);
                border: 1px solid rgba(0, 255, 255, 0.3);
                border-radius: 8px;
                color: #e6edf3;
                font-size: 14px;
                outline: none;
                transition: all 0.2s;
              "
              onfocus="this.style.borderColor='rgba(0, 255, 255, 0.6)'; this.style.boxShadow='0 0 0 3px rgba(0, 255, 255, 0.1)'"
              onblur="this.style.borderColor='rgba(0, 255, 255, 0.3)'; this.style.boxShadow='none'"
            />
            <button
              id="clear-search-btn"
              onclick="clearLeadsSearch()"
              style="
                position: absolute;
                right: 10px;
                top: 50%;
                transform: translateY(-50%);
                background: none;
                border: none;
                color: #6b7280;
                cursor: pointer;
                padding: 6px;
                display: none;
              "
              onmouseover="this.style.color='#00FFFF'"
              onmouseout="this.style.color='#6b7280'"
            >
              <svg style="width: 18px; height: 18px;" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
              </svg>
            </button>
          </div>
        </div>

        <!-- Leads Tabs -->
        <div style="display: flex; gap: 12px; margin-bottom: 20px; border-bottom: 2px solid rgba(0, 255, 255, 0.2);">
          <button class="leads-tab active" onclick="switchLeadsTab('pending')" id="tab-pending">
             Pending (<span id="pending-count">0</span>)
          </button>
          <button class="leads-tab" onclick="switchLeadsTab('approved')" id="tab-approved">
             Approved (<span id="approved-count">0</span>)
          </button>
          <button class="leads-tab" onclick="switchLeadsTab('denied')" id="tab-denied">
             Denied (<span id="denied-count">0</span>)
          </button>
        </div>

        <!-- Pending Leads -->
        <div id="leads-pending-container" class="leads-tab-content">
          <div style="padding: 40px; text-align: center; color: #7d8590;">
            <p>Loading pending leads...</p>
          </div>
        </div>

        <!-- Approved Leads -->
        <div id="leads-approved-container" class="leads-tab-content" style="display: none;">
          <div style="padding: 40px; text-align: center; color: #7d8590;">
            <p>Loading approved leads...</p>
          </div>
        </div>

        <!-- Denied Leads -->
        <div id="leads-denied-container" class="leads-tab-content" style="display: none;">
          <div style="padding: 40px; text-align: center; color: #7d8590;">
            <p>Loading denied leads...</p>
          </div>
        </div>
      </div>

      <div id="recent-calls-section" class="calls-section">
        <div class="section-header">
          <div class="section-title">Recent Calls</div>
          <div id="filters-section" class="filters-row">
            <!-- Quick Date Buttons -->
            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Quick Filters</label>
              <div style="display: flex; gap: 8px; align-items: center;">
                <button class="quick-date-btn" onclick="applyQuickDate('today')" title="Show today's calls">
                  Today
                </button>
                <button class="quick-date-btn" onclick="applyQuickDate('week')" title="Show this week's calls">
                  This Week
                </button>
                <button class="quick-date-btn" onclick="applyQuickDate('month')" title="Show this month's calls">
                  This Month
                </button>
              </div>
            </div>

            <!-- Quick Date Presets -->
            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Date Range</label>
              <select class="filter-select" id="date-preset" onchange="applyDatePreset()">
                <option value="custom">Custom Range</option>
                <option value="all">All Time</option>
                <option value="7">Last 7 Days</option>
                <option value="30" selected>Last 30 Days</option>
                <option value="90">Last 90 Days</option>
              </select>
            </div>

            <!-- Custom Date Range Inputs -->
            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">From Date</label>
              <input type="date" class="filter-select" id="date-from" style="min-width: 140px;" onchange="onDateRangeChange()">
            </div>

            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">To Date</label>
              <input type="date" class="filter-select" id="date-to" style="min-width: 140px;" onchange="onDateRangeChange()">
            </div>

            <!-- Multi-Select Category Filter -->
            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Category</label>
              <div class="multi-select-wrapper" style="position: relative;">
                <button class="filter-select" id="category-button" onclick="toggleCategoryDropdown()" style="display: flex; justify-content: space-between; align-items: center; cursor: pointer;">
                  <span id="category-button-text">All Categories</span>
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"></path>
                  </svg>
                </button>
              <div id="category-dropdown" class="category-dropdown" style="display: none;">
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="New Lead" onchange="updateCategoryFilter()" style="margin-right: 8px;"> New Lead
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="Existing Client" onchange="updateCategoryFilter()" style="margin-right: 8px;"> Existing Client
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="Attorney" onchange="updateCategoryFilter()" style="margin-right: 8px;"> Attorney
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="Insurance" onchange="updateCategoryFilter()" style="margin-right: 8px;"> Insurance
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="Medical" onchange="updateCategoryFilter()" style="margin-right: 8px;"> Medical
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="Other" onchange="updateCategoryFilter()" style="margin-right: 8px;"> Other
                </label>
                <label style="display: flex; align-items: center; padding: 8px 12px; cursor: pointer; transition: background 0.2s;">
                  <input type="checkbox" value="Uncategorized" onchange="updateCategoryFilter()" style="margin-right: 8px;"> Uncategorized
                </label>
                <div style="padding: 8px 12px; border-top: 1px solid rgba(0, 255, 255, 0.2); margin-top: 4px;">
                  <button onclick="clearCategoryFilter()" style="width: 100%; padding: 6px; background: rgba(107, 114, 128, 0.2); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.3); border-radius: 6px; font-size: 12px; cursor: pointer;">
                    Clear All
                  </button>
                </div>
              </div>
            </div>
            </div>

            <!-- Duration Filter -->
            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Duration</label>
              <select class="filter-select" id="duration-filter" onchange="filterCalls()" style="min-width: 150px;">
                <option value="all">All Durations</option>
                <option value="under30s">Under 30 seconds</option>
                <option value="under1m">Under 1 minute</option>
                <option value="over1m">Over 1 minute</option>
                <option value="over2m">Over 2 minutes</option>
                <option value="over5m">Over 5 minutes</option>
              </select>
            </div>

            <div style="display: flex; flex-direction: column; gap: 6px;">
              <label style="font-size: 11px; color: #7d8590; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Search</label>
              <input type="text" class="search-box" id="search-box" placeholder="Search calls..." style="min-width: 200px;">
            </div>

            <button class="action-btn" id="export-btn" onclick="exportToCSV()" style="position: relative;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path>
              </svg>
              Export CSV
              <span class="tooltip-icon" style="position: static; margin-left: 4px;">?
                <span class="tooltip-text">Download your call data as a CSV file (Shortcut: E)</span>
              </span>
            </button>

            <button class="action-btn" onclick="refreshDashboard()" style="position: relative;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path>
              </svg>
              Refresh
              <span class="tooltip-icon" style="position: static; margin-left: 4px;">?
                <span class="tooltip-text">Reload dashboard data from server (Shortcut: R)</span>
              </span>
            </button>
          </div>
        </div>
        <table id="calls-table">
          <thead>
            <tr>
              <th>Phone Number</th>
              <th>Date</th>
              <th>Duration</th>
              <th>Confidence</th>
              <th>Category</th>
            </tr>
          </thead>
          <tbody id="calls-tbody">
          </tbody>
        </table>

        <!-- Pagination -->
        <div class="pagination" id="pagination" style="display: none;">
          <div class="pagination-info" id="pagination-info"></div>
          <div class="pagination-controls">
            <button class="pagination-btn" id="prev-btn" onclick="changePage(-1)">
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline; vertical-align: middle; margin-right: 4px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 19l-7-7 7-7"></path>
              </svg>
              Prev
            </button>
            <div class="page-numbers" id="page-numbers"></div>
            <button class="pagination-btn" id="next-btn" onclick="changePage(1)">
              Next
              <svg width="14" height="14" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="display: inline; vertical-align: middle; margin-left: 4px;">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7"></path>
              </svg>
            </button>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Call Detail Modal -->
  <div id="call-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Call Details</h2>
        <span class="close" onclick="closeModal()">&times;</span>
      </div>
      <div class="modal-body" id="modal-body">
      </div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div id="settings-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2>Account Settings</h2>
        <span class="close" onclick="closeSettingsModal()">&times;</span>
      </div>
      <div class="modal-body">
        <!-- Tab Navigation -->
        <div style="display: flex; gap: 8px; border-bottom: 2px solid rgba(0, 255, 255, 0.2); margin-bottom: 32px;">
          <button class="settings-tab active" onclick="switchSettingsTab('account')" data-tab="account" style="padding: 12px 24px; background: none; border: none; color: #00FFFF; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-bottom: 3px solid #00FFFF; margin-bottom: -2px; transition: all 0.3s;">
            Account
          </button>
          <button class="settings-tab" onclick="switchSettingsTab('security')" data-tab="security" style="padding: 12px 24px; background: none; border: none; color: #6b7280; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.3s;">
            Security
          </button>
          <button class="settings-tab" onclick="switchSettingsTab('preferences')" data-tab="preferences" style="padding: 12px 24px; background: none; border: none; color: #6b7280; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.3s;">
            Preferences
          </button>
          <button class="settings-tab" onclick="switchSettingsTab('team')" data-tab="team" id="team-tab" style="padding: 12px 24px; background: none; border: none; color: #6b7280; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.3s; display: none;">
            Team
          </button>
          <button class="settings-tab" onclick="switchSettingsTab('notifications')" data-tab="notifications" style="padding: 12px 24px; background: none; border: none; color: #6b7280; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; cursor: pointer; border-bottom: 3px solid transparent; margin-bottom: -2px; transition: all 0.3s;">
            Notifications
          </button>
        </div>

        <!-- Account Tab -->
        <div id="account-tab-content" class="settings-tab-content">
          <div style="max-width: 600px;">
            <div style="margin-bottom: 28px;">
              <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
                Email Address
              </label>
              <input type="text" id="settings-email" readonly style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.4); color: #6b7280; cursor: not-allowed;">
              <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">Your account email address (cannot be changed)</p>
            </div>

            <div style="margin-bottom: 28px;">
              <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
                Business Name
              </label>
              <input type="text" id="settings-business" readonly style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.4); color: #6b7280; cursor: not-allowed;">
              <p style="font-size: 12px; color: #6b7280; margin-top: 8px;">Your business or organization name</p>
            </div>
          </div>
        </div>

        <!-- Security Tab -->
        <div id="security-tab-content" class="settings-tab-content" style="display: none;">
          <div style="max-width: 600px;">
            <h3 style="font-size: 18px; font-weight: 700; color: #00FFFF; margin-bottom: 8px; letter-spacing: 1px;">Change Password</h3>
            <p style="font-size: 13px; color: #9ca3af; margin-bottom: 24px;">Update your password to keep your account secure</p>

            <form id="settings-form" onsubmit="saveSettings(event)">
              <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
                  Current Password
                </label>
                <input type="password" id="current-password" placeholder="Enter current password" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
              </div>

              <div style="margin-bottom: 20px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
                  New Password
                </label>
                <input type="password" id="new-password" placeholder="Enter new password (min 8 characters)" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
              </div>

              <div style="margin-bottom: 28px;">
                <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
                  Confirm New Password
                </label>
                <input type="password" id="confirm-password" placeholder="Confirm new password" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
              </div>

              <div style="display: flex; gap: 12px;">
                <button type="button" onclick="clearPasswordFields()" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.2)); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                  Clear
                </button>
                <button type="submit" id="save-settings-btn" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                  Update Password
                </button>
              </div>
            </form>
          </div>
        </div>

        <!-- Preferences Tab -->
        <div id="preferences-tab-content" class="settings-tab-content" style="display: none;">
          <div style="max-width: 600px;">
            <h3 style="font-size: 18px; font-weight: 700; color: #00FFFF; margin-bottom: 8px; letter-spacing: 1px;">Dashboard Tour</h3>
            <p style="font-size: 13px; color: #9ca3af; margin-bottom: 24px;">Need a refresher? Retake the guided tour of your dashboard.</p>

            <div style="padding: 24px; background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; margin-bottom: 32px;">
              <p style="font-size: 14px; color: #e6edf3; line-height: 1.6; margin-bottom: 20px;">
                The dashboard tour will show you:
              </p>
              <ul style="font-size: 14px; color: #9ca3af; line-height: 2; margin-left: 20px; margin-bottom: 20px;">
                <li>How to track new leads</li>
                <li>Understanding call categories</li>
                <li>Using filters and search</li>
                <li>Exporting call data</li>
                <li>Keyboard shortcuts</li>
              </ul>
              <button onclick="retakeTour()" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                 Start Tour
              </button>
            </div>
          </div>
        </div>

        <!-- Team Tab -->
        <div id="team-tab-content" class="settings-tab-content team-section" style="display: none;">
          <h3 style="font-size: 18px; font-weight: 700; color: #00FFFF; margin-bottom: 20px; letter-spacing: 1px;">Team Members</h3>

          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
            <button onclick="openAddTeamMember()" style="padding: 10px 20px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              + Add Member
            </button>
          </div>

          <div style="overflow-x: auto;">
            <table style="width: 100%; border-collapse: collapse;">
              <thead>
                <tr style="background: rgba(13, 17, 23, 0.6); border-bottom: 2px solid rgba(0, 255, 255, 0.2);">
                  <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Name</th>
                  <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Email</th>
                  <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Role</th>
                  <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Last Login</th>
                  <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Status</th>
                  <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Actions</th>
                </tr>
              </thead>
              <tbody id="team-members-tbody-settings">
                <tr>
                  <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">No team members yet. Add one to get started!</td>
                </tr>
              </tbody>
            </table>
          </div>

          <!-- Activity Log (moved inside Team Management) -->
          <div style="margin-top: 32px; padding-top: 32px; border-top: 2px solid rgba(0, 255, 255, 0.2);">
            <div style="margin-bottom: 24px;">
              <h4 style="font-size: 16px; font-weight: 700; color: #00FFFF; margin-bottom: 6px;">Team Activity Log</h4>
              <p style="font-size: 12px; color: #9ca3af;">Recent actions performed by team members</p>
            </div>

            <div style="overflow-x: auto; max-height: 400px; overflow-y: auto;">
              <table style="width: 100%; border-collapse: collapse;">
                <thead style="position: sticky; top: 0; background: rgba(13, 17, 23, 0.95); z-index: 1;">
                  <tr style="border-bottom: 2px solid rgba(0, 255, 255, 0.2);">
                    <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Time</th>
                    <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Team Member</th>
                    <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Role</th>
                    <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Action</th>
                    <th style="text-align: left; padding: 16px 20px; font-size: 11px; font-weight: 700; color: #9ca3af; text-transform: uppercase; letter-spacing: 1.5px;">Details</th>
                  </tr>
                </thead>
                <tbody id="activity-log-tbody-settings">
                  <tr>
                    <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No activity recorded yet</td>
                  </tr>
                </tbody>
              </table>
            </div>
          </div>
        </div>

        <!-- Notifications Tab -->
        <div id="notifications-tab-content" class="settings-tab-content" style="display: none;">
          <h3 style="font-size: 18px; font-weight: 700; color: #00FFFF; margin-bottom: 8px; letter-spacing: 1px;">Notification Recipients</h3>
          <p style="font-size: 13px; color: #9ca3af; margin-bottom: 24px;">Manage who receives email and SMS notifications for each call category.</p>

          <div style="display: flex; justify-content: flex-end; margin-bottom: 16px;">
            <button onclick="openAddNotificationRecipient()" style="padding: 10px 20px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              + Add Recipient
            </button>
          </div>

          <div id="notification-recipients-container">
            <div style="text-align: center; padding: 40px; color: #9ca3af;">
              <p>Loading notification settings...</p>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Add Notification Recipient Modal -->
  <div id="add-recipient-modal" class="modal">
    <div class="modal-content" style="max-width: 500px;">
      <div class="modal-header">
        <h2>Add Notification Recipient</h2>
        <span class="close" onclick="closeAddRecipientModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="add-recipient-form" onsubmit="saveNotificationRecipient(event)">
          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Full Name *
            </label>
            <input type="text" id="recipient-name" required placeholder="John Doe" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Email Address *
            </label>
            <input type="email" id="recipient-email" required placeholder="john@example.com" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
          </div>

          <div style="margin-bottom: 24px;">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Phone Number (for SMS)
            </label>
            <input type="tel" id="recipient-phone" placeholder="+1234567890" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
            <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">Required if you want this person to receive SMS notifications</div>
          </div>

          <div style="display: flex; gap: 12px;">
            <button type="button" onclick="closeAddRecipientModal()" style="flex: 1; padding: 12px 24px; background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.2)); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              Cancel
            </button>
            <button type="submit" id="save-recipient-btn" style="flex: 1; padding: 12px 24px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              Add Recipient
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Team Member Modal -->
  <div id="team-member-modal" class="modal">
    <div class="modal-content">
      <div class="modal-header">
        <h2 id="team-modal-title">Add Team Member</h2>
        <span class="close" onclick="closeTeamMemberModal()">&times;</span>
      </div>
      <div class="modal-body">
        <form id="team-member-form" onsubmit="saveTeamMember(event)">
          <input type="hidden" id="team-member-id">

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Full Name
            </label>
            <input type="text" id="team-member-name" required placeholder="John Doe" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Email Address
            </label>
            <input type="email" id="team-member-email" required placeholder="john@example.com" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
            <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">This will be their login email</div>
          </div>

          <div style="margin-bottom: 20px;">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Role
            </label>
            <select id="team-member-role" required style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3; cursor: pointer;">
              <option value="Admin">Admin - Full access to all features</option>
              <option value="Sales">Sales - View calls, export data</option>
              <option value="Support">Support - View calls only</option>
              <option value="Viewer">Viewer - Read-only access</option>
            </select>
          </div>

          <div style="margin-bottom: 24px;" id="password-section">
            <label style="display: block; font-size: 12px; font-weight: 700; color: #9ca3af; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 1.5px;">
              Initial Password
            </label>
            <input type="password" id="team-member-password" placeholder="Minimum 8 characters" style="width: 100%; padding: 14px 18px; font-size: 15px; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-family: 'JetBrains Mono', monospace; background: rgba(13, 17, 23, 0.6); color: #e6edf3;">
            <div style="font-size: 11px; color: #6b7280; margin-top: 6px;">Leave blank when editing to keep existing password</div>
          </div>

          <div style="display: flex; gap: 12px; justify-content: flex-end;">
            <button type="button" onclick="closeTeamMemberModal()" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(107, 114, 128, 0.2), rgba(75, 85, 99, 0.2)); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              Cancel
            </button>
            <button type="submit" id="save-team-member-btn" style="padding: 12px 24px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
              Save Member
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <script>
    let currentUser = null;
    let allCalls = [];
    let categories = {};
    let currentPage = 1;
    let itemsPerPage = 25;
    let filteredCalls = [];

    // Toast Notification System
    function showToast(message, type = 'info', duration = 4000) {
      const container = document.getElementById('toast-container');
      const toast = document.createElement('div');
      toast.className = `toast toast-${type}`;

      const icons = {
        success: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>',
        error: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>',
        info: '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>'
      };

      toast.innerHTML = `
        <div class="toast-icon">${icons[type]}</div>
        <div class="toast-message">${message}</div>
        <button class="toast-close" onclick="this.parentElement.remove()">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24">
            <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path>
          </svg>
        </button>
      `;

      container.appendChild(toast);

      // Auto-remove after duration
      if (duration > 0) {
        setTimeout(() => {
          toast.classList.add('removing');
          setTimeout(() => toast.remove(), 300);
        }, duration);
      }
    }

    // Check authentication and load user data
    async function checkAuth() {
      try {
        // Try client auth first
        let response = await fetch('/api/auth/me', {
          credentials: 'include'
        });

        // If client auth fails, try team member auth
        if (!response.ok) {
          response = await fetch('/api/team/auth/me', {
            credentials: 'include'
          });
        }

        if (!response.ok) {
          // Not logged in, redirect to login
          window.location.href = '/client-portal';
          return;
        }

        currentUser = await response.json();
        document.getElementById('business-name').textContent = currentUser.business_name;

        // Load data
        await loadDashboard();
      } catch (error) {
        console.error('Auth check failed:', error);
        window.location.href = '/client-portal';
      }
    }

    async function loadDashboard() {
      try {
        // Load categories
        const catResponse = await fetch('/api/categories', {
          credentials: 'include'
        });
        if (catResponse.ok) {
          categories = await catResponse.json();
        }

        // Load all calls
        const callsResponse = await fetch('/api/agent-summary', {
          credentials: 'include'
        });

        if (!callsResponse.ok) {
          if (callsResponse.status === 401 || callsResponse.status === 403) {
            throw new Error('AUTH_ERROR');
          } else if (callsResponse.status >= 500) {
            throw new Error('SERVER_ERROR');
          } else {
            throw new Error('NETWORK_ERROR');
          }
        }

        const data = await callsResponse.json();

        // Filter calls to only show this client's agent(s)
        allCalls = data.all_calls.filter(call =>
          currentUser.agent_ids.includes(call.agent_id)
        );

        // Load team members
        loadTeamMembers();

        // Load activity log (now part of team section)
        loadActivityLog();

        // Load client leads
        loadClientLeads();

        renderDashboard();
        checkOnboarding();
      } catch (error) {
        console.error('Error loading dashboard:', error);
        // If error message is not one of our custom types, it's likely a network failure
        if (!['AUTH_ERROR', 'SERVER_ERROR', 'NETWORK_ERROR'].includes(error.message)) {
          showErrorState('NETWORK_ERROR');
        } else {
          showErrorState(error.message);
        }
      }
    }

    function showErrorState(errorType) {
      const loadingDiv = document.getElementById('loading');
      let errorMessage = '';
      let errorDetails = '';

      if (errorType === 'AUTH_ERROR') {
        errorMessage = 'Authentication Error';
        errorDetails = 'Your session has expired. Please log in again.';
        setTimeout(() => {
          window.location.href = '/client-portal';
        }, 3000);
      } else if (errorType === 'SERVER_ERROR') {
        errorMessage = 'Server Error';
        errorDetails = 'The server is experiencing issues. Please try again in a moment.';
      } else if (errorType === 'NETWORK_ERROR') {
        errorMessage = 'Network Error';
        errorDetails = 'Unable to connect to the server. Please check your internet connection.';
      } else {
        errorMessage = 'Error Loading Dashboard';
        errorDetails = 'Something went wrong. Please try again.';
      }

      loadingDiv.innerHTML = `
        <div style="text-align: center; padding: 48px 24px; max-width: 500px; margin: 0 auto;">
          <div style="font-size: 48px; margin-bottom: 20px;"></div>
          <h2 style="color: #ff6b6b; font-size: 24px; margin-bottom: 12px; font-weight: 700;">${errorMessage}</h2>
          <p style="color: #9ca3af; font-size: 15px; margin-bottom: 32px; line-height: 1.6;">${errorDetails}</p>
          ${errorType !== 'AUTH_ERROR' ? `
            <button onclick="retryLoadDashboard()" style="padding: 14px 32px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 14px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px; transition: all 0.3s;">
              Retry
            </button>
          ` : `
            <p style="color: #6b7280; font-size: 13px; margin-top: 16px;">Redirecting to login page...</p>
          `}
        </div>
      `;
    }

    function retryLoadDashboard() {
      const loadingDiv = document.getElementById('loading');
      loadingDiv.innerHTML = '<div class="loading-spinner"></div><p style="margin-top: 16px; color: #9ca3af;">Loading your dashboard...</p>';
      loadDashboard();
    }

    function renderDashboard() {
      // Calculate stats
      const totalCalls = allCalls.length;
      const newLeads = allCalls.filter(call => categories[call.call_id]?.category === 'New Lead').length;
      const existingClients = allCalls.filter(call => categories[call.call_id]?.category === 'Existing Client').length;
      const otherCalls = allCalls.filter(call => {
        const cat = categories[call.call_id]?.category;
        return cat === 'Attorney' || cat === 'Insurance' || cat === 'Medical' || cat === 'Other' || !cat;
      }).length;

      document.getElementById('total-calls').textContent = totalCalls;
      document.getElementById('new-leads').textContent = newLeads;
      document.getElementById('existing-clients').textContent = existingClients;
      document.getElementById('other-calls').textContent = otherCalls;

      // Render analytics charts
      renderCallsOverTimeChart();
      renderCategoryDistributionChart();

      // Render calls table
      renderCallsTable(allCalls);

      // Show dashboard
      document.getElementById('loading').style.display = 'none';
      document.getElementById('dashboard-content').style.display = 'block';
    }

    function renderCallsOverTimeChart() {
      const chartContainer = document.getElementById('calls-over-time-chart');
      const days = 7;

      // Get today at midnight (start of day)
      const today = new Date();
      today.setHours(0, 0, 0, 0);

      // Prepare data for last 7 days (using calendar days, not 24hr periods)
      const dailyData = [];
      for (let i = days - 1; i >= 0; i--) {
        const dayStart = new Date(today);
        dayStart.setDate(today.getDate() - i);
        const dayStartMs = dayStart.getTime();

        const dayEnd = new Date(dayStart);
        dayEnd.setDate(dayStart.getDate() + 1);
        const dayEndMs = dayEnd.getTime();

        const label = dayStart.toLocaleDateString('en-US', { weekday: 'short' });

        const callsCount = allCalls.filter(call =>
          call.start_timestamp && call.start_timestamp >= dayStartMs && call.start_timestamp < dayEndMs
        ).length;

        dailyData.push({ label, count: callsCount });
      }

      // Dynamic percentage-based scaling - bars will ALWAYS fit
      const maxCount = Math.max(...dailyData.map(d => d.count), 1);
      const minBarPercent = 8; // Minimum bar height percentage (ensures visibility)
      const maxBarPercent = 85; // Maximum bar height percentage (leaves room for labels)

      // Render bars with percentage-based heights
      chartContainer.innerHTML = dailyData.map(day => {
        let heightPercent;
        if (maxCount === 0) {
          heightPercent = minBarPercent;
        } else {
          // Scale linearly from minBarPercent to maxBarPercent
          const ratio = day.count / maxCount;
          heightPercent = minBarPercent + (ratio * (maxBarPercent - minBarPercent));
        }

        return `
          <div class="bar-wrapper">
            <div class="bar-container">
              <div class="bar" style="height: ${heightPercent.toFixed(1)}%" title="${day.count} calls on ${day.label}"></div>
            </div>
            <div class="bar-label-group">
              <div class="bar-label">${day.label}</div>
              <div class="bar-value">${day.count}</div>
            </div>
          </div>
        `;
      }).join('');
    }

    function renderCategoryDistributionChart() {
      const chartContainer = document.getElementById('category-distribution-chart');

      if (allCalls.length === 0) {
        chartContainer.innerHTML = `
          <div style="display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 40px; text-align: center;">
            <svg width="48" height="48" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #6b7280; margin-bottom: 16px;">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path>
            </svg>
            <div style="font-size: 14px; color: #9ca3af;">No data available</div>
          </div>
        `;
        return;
      }

      // Count calls by category
      const categoryCounts = {
        'New Lead': 0,
        'Existing Client': 0,
        'Attorney': 0,
        'Insurance': 0,
        'Medical': 0,
        'Other': 0,
        'Uncategorized': 0
      };

      allCalls.forEach(call => {
        const cat = categories[call.call_id]?.category || 'Uncategorized';
        if (categoryCounts.hasOwnProperty(cat)) {
          categoryCounts[cat]++;
        } else {
          categoryCounts['Other']++;
        }
      });

      const totalCalls = allCalls.length || 1;
      const categoryColors = {
        'New Lead': '#10b981',
        'Existing Client': '#3b82f6',
        'Attorney': '#a855f7',
        'Insurance': '#f59e0b',
        'Medical': '#ef4444',
        'Other': '#6b7280',
        'Uncategorized': '#374151'
      };

      // Render category bars showing actual percentage of total
      chartContainer.innerHTML = Object.entries(categoryCounts)
        .filter(([_, count]) => count > 0)
        .sort((a, b) => b[1] - a[1])
        .map(([category, count]) => {
          const percentage = ((count / totalCalls) * 100);
          // Bar width = actual percentage (so 58.8% shows as ~59% width)
          // Minimum 12% width to ensure count number is visible
          const widthPercent = Math.max(12, percentage);
          const color = categoryColors[category];

          return `
            <div class="category-item">
              <div class="category-left">
                <div class="category-color" style="background: ${color};"></div>
                <div class="category-name">${category}</div>
              </div>
              <div class="category-bar-bg">
                <div class="category-bar-fill" style="width: ${widthPercent.toFixed(1)}%; background: linear-gradient(90deg, ${color}, ${color}cc);">
                  <span class="category-count">${count}</span>
                </div>
              </div>
              <div class="category-percentage">${percentage.toFixed(1)}%</div>
            </div>
          `;
        }).join('');
    }

    function renderCallsTable(calls) {
      const tbody = document.getElementById('calls-tbody');
      filteredCalls = calls;

      if (calls.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 60px 20px;">
              <div style="display: flex; flex-direction: column; align-items: center; gap: 16px;">
                <svg width="64" height="64" fill="none" stroke="currentColor" viewBox="0 0 24 24" style="color: #6b7280;">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="1.5" d="M20 13V6a2 2 0 00-2-2H6a2 2 0 00-2 2v7m16 0v5a2 2 0 01-2 2H6a2 2 0 01-2-2v-5m16 0h-2.586a1 1 0 00-.707.293l-2.414 2.414a1 1 0 01-.707.293h-3.172a1 1 0 01-.707-.293l-2.414-2.414A1 1 0 006.586 13H4"></path>
                </svg>
                <div>
                  <div style="font-size: 18px; font-weight: 700; color: #e6edf3; margin-bottom: 8px;">No calls found</div>
                  <div style="font-size: 14px; color: #9ca3af;">Try adjusting your filters or date range to see more results</div>
                </div>
              </div>
            </td>
          </tr>
        `;
        document.getElementById('pagination').style.display = 'none';
        return;
      }

      // Sort by date (newest first)
      const sortedCalls = [...calls].sort((a, b) =>
        (b.start_timestamp || 0) - (a.start_timestamp || 0)
      );

      // Pagination logic
      const totalPages = Math.ceil(sortedCalls.length / itemsPerPage);
      const startIndex = (currentPage - 1) * itemsPerPage;
      const endIndex = startIndex + itemsPerPage;
      const paginatedCalls = sortedCalls.slice(startIndex, endIndex);

      tbody.innerHTML = paginatedCalls.map(call => {
        const date = call.start_timestamp
          ? new Date(call.start_timestamp).toLocaleString()
          : 'N/A';
        const duration = formatDuration(call.duration_minutes || 0);
        const phoneNumber = call.from_number || call.to_number || call.customer_number || 'N/A';
        const category = categories[call.call_id]?.category || 'Uncategorized';
        const confidence = categories[call.call_id]?.confidence_score;
        const confidenceDisplay = formatConfidence(confidence);

        return `
          <tr onclick="openCallModal('${call.call_id}')">
            <td data-label="Phone">${phoneNumber}</td>
            <td data-label="Date">${date}</td>
            <td data-label="Duration">${duration}</td>
            <td data-label="Confidence">${confidenceDisplay}</td>
            <td data-label="Category">${getCategoryBadge(category)}</td>
          </tr>
        `;
      }).join('');

      // Update pagination
      updatePagination(sortedCalls.length, totalPages);
    }

    function updatePagination(totalItems, totalPages) {
      const pagination = document.getElementById('pagination');
      const paginationInfo = document.getElementById('pagination-info');
      const pageNumbers = document.getElementById('page-numbers');
      const prevBtn = document.getElementById('prev-btn');
      const nextBtn = document.getElementById('next-btn');

      if (totalPages <= 1) {
        pagination.style.display = 'none';
        return;
      }

      pagination.style.display = 'flex';

      // Update info text
      const startItem = (currentPage - 1) * itemsPerPage + 1;
      const endItem = Math.min(currentPage * itemsPerPage, totalItems);
      paginationInfo.textContent = `Showing ${startItem}-${endItem} of ${totalItems} calls`;

      // Update prev/next buttons
      prevBtn.disabled = currentPage === 1;
      nextBtn.disabled = currentPage === totalPages;

      // Generate page numbers (show max 7 pages)
      const maxPages = 7;
      let startPage = Math.max(1, currentPage - Math.floor(maxPages / 2));
      let endPage = Math.min(totalPages, startPage + maxPages - 1);

      if (endPage - startPage < maxPages - 1) {
        startPage = Math.max(1, endPage - maxPages + 1);
      }

      let pagesHTML = '';

      // First page
      if (startPage > 1) {
        pagesHTML += `<button class="page-number" onclick="goToPage(1)">1</button>`;
        if (startPage > 2) {
          pagesHTML += `<span style="color: #6b7280; padding: 0 8px;">...</span>`;
        }
      }

      // Page numbers
      for (let i = startPage; i <= endPage; i++) {
        pagesHTML += `<button class="page-number ${i === currentPage ? 'active' : ''}" onclick="goToPage(${i})">${i}</button>`;
      }

      // Last page
      if (endPage < totalPages) {
        if (endPage < totalPages - 1) {
          pagesHTML += `<span style="color: #6b7280; padding: 0 8px;">...</span>`;
        }
        pagesHTML += `<button class="page-number" onclick="goToPage(${totalPages})">${totalPages}</button>`;
      }

      pageNumbers.innerHTML = pagesHTML;
    }

    function changePage(delta) {
      const totalPages = Math.ceil(filteredCalls.length / itemsPerPage);
      const newPage = currentPage + delta;
      if (newPage >= 1 && newPage <= totalPages) {
        currentPage = newPage;
        renderCallsTable(filteredCalls);
        // Scroll to top of table
        document.getElementById('calls-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
      }
    }

    function goToPage(page) {
      currentPage = page;
      renderCallsTable(filteredCalls);
      // Scroll to top of table
      document.getElementById('calls-table').scrollIntoView({ behavior: 'smooth', block: 'start' });
    }

    function formatDuration(minutes) {
      const mins = Math.floor(minutes);
      const secs = Math.round((minutes - mins) * 60);
      return `${mins}:${secs.toString().padStart(2, '0')}`;
    }

    function formatConfidence(score) {
      // If no confidence score, show N/A
      if (score === null || score === undefined) {
        return '<span class="confidence-badge confidence-na" title="Confidence score not available">N/A</span>';
      }

      // Convert to percentage if needed (0-1 scale to 0-100)
      const percentage = score <= 1 ? Math.round(score * 100) : Math.round(score);

      // Determine confidence level and styling
      let level, color, icon, tooltip;
      if (percentage >= 90) {
        level = 'Very High';
        color = '#10b981'; // Green
        icon = '';
        tooltip = `${percentage}% - AI is very confident in this categorization`;
      } else if (percentage >= 75) {
        level = 'High';
        color = '#22c55e'; // Light green
        icon = '';
        tooltip = `${percentage}% - AI is highly confident in this categorization`;
      } else if (percentage >= 60) {
        level = 'Medium';
        color = '#f59e0b'; // Orange
        icon = '~';
        tooltip = `${percentage}% - AI has moderate confidence in this categorization`;
      } else if (percentage >= 40) {
        level = 'Low';
        color = '#ef4444'; // Red
        icon = '?';
        tooltip = `${percentage}% - AI has low confidence, manual review recommended`;
      } else {
        level = 'Very Low';
        color = '#dc2626'; // Dark red
        icon = '??';
        tooltip = `${percentage}% - AI has very low confidence, manual review needed`;
      }

      return `<span class="confidence-badge" style="color: ${color}; border-color: ${color}; background: ${color}15;" title="${tooltip}">
        <span style="margin-right: 4px;">${icon}</span>${level} (${percentage}%)
      </span>`;
    }

    function getCategoryBadge(category) {
      const className = category.toLowerCase().replace(/\s+/g, '-');
      return `<span class="category-badge category-${className}">${category}</span>`;
    }

    function openCallModal(callId) {
      const call = allCalls.find(c => c.call_id === callId);
      if (!call) return;

      const modal = document.getElementById('call-modal');
      const modalBody = document.getElementById('modal-body');

      const date = call.start_timestamp ? new Date(call.start_timestamp).toLocaleString() : 'N/A';
      const endDate = call.end_timestamp ? new Date(call.end_timestamp).toLocaleString() : 'Ongoing';
      const duration = formatDuration(call.duration_minutes || 0);
      const phoneNumber = call.from_number || call.to_number || call.customer_number || 'N/A';
      const status = call.end_timestamp ? 'Completed' : 'Ongoing';
      const category = categories[call.call_id]?.category || 'Uncategorized';

      // Check if transcript/recording data is already loaded
      let transcriptData = call.transcript || call.transcript_object;
      let recordingUrl = call.recording_url;
      const hasData = transcriptData || recordingUrl;

      let contentHTML = '';

      if (!hasData) {
        // Show lazy load button
        contentHTML = `
          <div id="lazy-load-container-${callId}" style="text-align: center; padding: 48px 32px;">
            <button onclick="loadTranscriptAndRecordingForModal('${callId}')" id="load-btn-${callId}" style="padding: 16px 32px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 8px; font-size: 14px; font-weight: 600; cursor: pointer; transition: all 0.2s ease;">
               Click here to load the transcript and call recording
            </button>
          </div>
        `;
      } else {
        // Build content with recording and transcript
        if (recordingUrl) {
          contentHTML += `
            <div class="audio-section">
              <div class="transcript-title"> Call Recording</div>
              <audio controls style="width: 100%; margin-top: 8px;">
                <source src="${recordingUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </div>
          `;
        }

        // Format transcript
        let transcriptHTML = '<div class="transcript-box">';

        if (typeof transcriptData === 'string') {
          try {
            transcriptData = JSON.parse(transcriptData);
          } catch (e) {}
        }

        if (Array.isArray(transcriptData)) {
          transcriptData.forEach(msg => {
            const role = (msg.role || 'unknown').toUpperCase();
            const content = msg.content || '';
            const className = msg.role === 'user' ? 'transcript-user' : 'transcript-agent';
            transcriptHTML += `
              <div class="transcript-message ${className}">
                <div class="transcript-role">${role}</div>
                <div>${content}</div>
              </div>
            `;
          });
        } else if (typeof transcriptData === 'string') {
          transcriptHTML += `<div style="white-space: pre-wrap;">${transcriptData}</div>`;
        } else {
          transcriptHTML += '<div style="color: #a0aec0; font-style: italic;">No transcript available</div>';
        }
        transcriptHTML += '</div>';

        contentHTML += `
          <div class="transcript-section">
            <div class="transcript-title"> Call Transcript</div>
            ${transcriptHTML}
          </div>
        `;
      }

      // Extract "where heard about" information
      const heardAbout = call.extracted_data?.referral_source ||
                        call.extracted_data?.heard_about ||
                        call.call_analysis?.referral_source ||
                        null;

      // Extract call summary
      const callSummary = call.call_analysis?.call_summary ||
                         categories[call.call_id]?.reasoning ||
                         null;

      modalBody.innerHTML = `
        <div class="field-grid">
          <div class="field">
            <div class="field-label">Phone Number</div>
            <div class="field-value">${phoneNumber}</div>
          </div>
          <div class="field">
            <div class="field-label">Duration</div>
            <div class="field-value">${duration}</div>
          </div>
          <div class="field">
            <div class="field-label">Start Time</div>
            <div class="field-value">${date}</div>
          </div>
          <div class="field">
            <div class="field-label">End Time</div>
            <div class="field-value">${endDate}</div>
          </div>
          <div class="field">
            <div class="field-label">Status</div>
            <div class="field-value"><span class="status-badge status-${status.toLowerCase()}">${status}</span></div>
          </div>
          <div class="field">
            <div class="field-label">Category</div>
            <div class="field-value" id="modal-category-${callId}">
              ${getCategoryBadge(category)}
              <button onclick="showCategoryEditor('${callId}')" style="margin-left: 12px; padding: 6px 12px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Change</button>
            </div>
            <div id="category-editor-${callId}" style="display: none; margin-top: 12px; padding: 16px; background: rgba(0, 255, 255, 0.05); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 4px;">
              <select id="category-select-${callId}" style="width: 100%; padding: 10px; border: 1px solid rgba(48, 54, 61, 0.8); background: rgba(13, 17, 23, 0.8); color: #e6edf3; border-radius: 4px; font-size: 13px; margin-bottom: 10px;">
                <option value="New Lead">New Lead</option>
                <option value="Existing Client">Existing Client</option>
                <option value="Attorney">Attorney</option>
                <option value="Insurance">Insurance</option>
                <option value="Medical">Medical</option>
                <option value="Other">Other</option>
              </select>
              <div style="display: flex; gap: 10px;">
                <button onclick="saveCategoryChange('${callId}')" style="flex: 1; padding: 8px; background: rgba(16, 185, 129, 0.2); color: #10b981; border: 1px solid rgba(16, 185, 129, 0.4); border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; text-transform: uppercase;">Save</button>
                <button onclick="hideCategoryEditor('${callId}')" style="flex: 1; padding: 8px; background: rgba(107, 114, 128, 0.2); color: #9ca3af; border: 1px solid rgba(107, 114, 128, 0.4); border-radius: 4px; font-size: 12px; cursor: pointer; font-weight: 600; text-transform: uppercase;">Cancel</button>
              </div>
            </div>
          </div>
          ${heardAbout ? `
            <div class="field">
              <div class="field-label">Where Heard About CourtLaw</div>
              <div class="field-value" style="color: #00FFFF;"> ${heardAbout}</div>
            </div>
          ` : ''}
        </div>

        ${callSummary ? `
          <div style="background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 12px; padding: 20px; margin: 20px 0;">
            <div style="color: #00FFFF; font-weight: 700; font-size: 13px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
               Call Summary
            </div>
            <div style="color: #e6edf3; line-height: 1.7; font-size: 14px;">
              ${callSummary}
            </div>
          </div>
        ` : ''}

        ${contentHTML}
      `;

      modal.style.display = 'block';
    }

    function closeModal() {
      const modal = document.getElementById('call-modal');
      const audioElements = modal.querySelectorAll('audio');
      audioElements.forEach(audio => {
        audio.pause();
        audio.currentTime = 0;
      });
      modal.style.display = 'none';
    }

    // Category Editor Functions
    function showCategoryEditor(callId) {
      const editor = document.getElementById(`category-editor-${callId}`);
      const select = document.getElementById(`category-select-${callId}`);

      if (!editor || !select) return;

      // Set current category as selected
      const currentCategory = categories[callId]?.category || 'Other';
      select.value = currentCategory;

      editor.style.display = 'block';
    }

    function hideCategoryEditor(callId) {
      const editor = document.getElementById(`category-editor-${callId}`);
      if (editor) {
        editor.style.display = 'none';
      }
    }

    async function saveCategoryChange(callId) {
      const select = document.getElementById(`category-select-${callId}`);
      if (!select) return;

      const newCategory = select.value;
      const saveButton = select.parentElement.querySelector('button');

      // Show loading state
      if (saveButton) {
        saveButton.textContent = 'Saving...';
        saveButton.disabled = true;
      }

      try {
        const res = await fetch('/api/update-category', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            call_id: callId,
            category: newCategory,
            reasoning: 'Manually categorized by client'
          })
        });

        if (!res.ok) {
          throw new Error(`Failed to update category: ${res.status}`);
        }

        const result = await res.json();

        // Update local categories
        categories[callId] = {
          ...categories[callId],
          category: newCategory,
          reasoning: 'Manually categorized by client',
          manual: true
        };

        // Update the modal display
        const modalCategory = document.getElementById(`modal-category-${callId}`);
        if (modalCategory) {
          modalCategory.innerHTML = `
            ${getCategoryBadge(newCategory)}
            <button onclick="showCategoryEditor('${callId}')" style="margin-left: 12px; padding: 6px 12px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 4px; font-size: 11px; cursor: pointer; font-weight: 600; text-transform: uppercase; letter-spacing: 0.5px;">Change</button>
          `;
        }

        // Hide editor
        hideCategoryEditor(callId);

        // Refresh the calls table to show updated category
        renderCallsTable(filteredCalls);

        // Refresh stats if Lead Tracker is affected
        if (result.lead_removed || newCategory === 'New Lead') {
          await loadClientLeads();
        }

        // Update category distribution chart
        renderCategoryDistributionChart();

        console.log(` Updated category for ${callId} to ${newCategory}`);

        // Show success notification
        const notification = document.createElement('div');
        notification.style.cssText = 'position: fixed; top: 20px; right: 20px; background: rgba(16, 185, 129, 0.9); color: white; padding: 12px 24px; border-radius: 8px; z-index: 10000; font-weight: 600;';
        notification.textContent = `Category updated to ${newCategory}`;
        document.body.appendChild(notification);
        setTimeout(() => notification.remove(), 3000);

      } catch (error) {
        alert(`Error updating category: ${error.message}`);
        console.error('Error:', error);

        // Reset button
        if (saveButton) {
          saveButton.textContent = 'Save';
          saveButton.disabled = false;
        }
      }
    }

    // Generic modal helper function
    function showModal(title, contentHTML) {
      const modal = document.getElementById('call-modal');
      const modalHeader = modal.querySelector('.modal-header h2');
      const modalBody = document.getElementById('modal-body');

      // Update modal title and content
      modalHeader.textContent = title;
      modalBody.innerHTML = contentHTML;

      // Show modal
      modal.style.display = 'block';
    }

    async function loadTranscriptAndRecordingForModal(callId) {
      const button = document.getElementById(`load-btn-${callId}`);
      const container = document.getElementById(`lazy-load-container-${callId}`);

      if (!button || !container) return;

      button.textContent = ' Loading...';
      button.disabled = true;

      try {
        const response = await fetch(`/api/calls/${callId}`);
        if (!response.ok) throw new Error(`HTTP ${response.status}`);

        const callDetails = await response.json();
        let transcriptData = callDetails.transcript || callDetails.transcript_object;
        let recordingUrl = callDetails.recording_url;

        // Update cache
        const callIndex = allCalls.findIndex(c => c.call_id === callId);
        if (callIndex !== -1) {
          allCalls[callIndex].transcript = transcriptData;
          allCalls[callIndex].transcript_object = transcriptData;
          allCalls[callIndex].recording_url = recordingUrl;
        }

        // Build HTML with recording first, then transcript
        let contentHTML = '';

        if (recordingUrl) {
          contentHTML += `
            <div class="audio-section">
              <div class="transcript-title"> Call Recording</div>
              <audio controls style="width: 100%; margin-top: 8px;">
                <source src="${recordingUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </div>
          `;
        }

        // Format transcript
        let transcriptHTML = '<div class="transcript-box">';

        if (typeof transcriptData === 'string') {
          try {
            transcriptData = JSON.parse(transcriptData);
          } catch (e) {}
        }

        if (Array.isArray(transcriptData) && transcriptData.length > 0) {
          transcriptData.forEach(msg => {
            const role = (msg.role || 'unknown').toUpperCase();
            const content = msg.content || '';
            const className = msg.role === 'user' ? 'transcript-user' : 'transcript-agent';
            transcriptHTML += `
              <div class="transcript-message ${className}">
                <div class="transcript-role">${role}</div>
                <div>${content}</div>
              </div>
            `;
          });
        } else if (typeof transcriptData === 'string' && transcriptData.trim()) {
          transcriptHTML += `<div style="white-space: pre-wrap;">${transcriptData}</div>`;
        } else {
          transcriptHTML += '<div style="color: #a0aec0; font-style: italic;">No transcript available</div>';
        }
        transcriptHTML += '</div>';

        contentHTML += `
          <div class="transcript-section">
            <div class="transcript-title"> Call Transcript</div>
            ${transcriptHTML}
          </div>
        `;

        // Replace button with content
        container.outerHTML = contentHTML;

      } catch (error) {
        console.error('Error loading transcript and recording:', error);
        button.textContent = ' Error loading. Click to retry';
        button.disabled = false;
      }
    }

    async function logout() {
      try {
        await fetch('/api/auth/logout', {
          method: 'POST',
          credentials: 'include'
        });
        window.location.href = '/client-portal';
      } catch (error) {
        console.error('Logout error:', error);
        window.location.href = '/client-portal';
      }
    }

    // Settings Functions
    function openSettings() {
      document.getElementById('settings-email').value = currentUser.email || '';
      document.getElementById('settings-business').value = currentUser.business_name || '';
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';

      // Show team tab if user is client owner (not team member)
      if (!currentUser.is_team_member) {
        document.getElementById('team-tab').style.display = 'block';
      }

      // Switch to account tab by default
      switchSettingsTab('account');

      document.getElementById('settings-modal').style.display = 'block';
    }

    function closeSettingsModal() {
      document.getElementById('settings-modal').style.display = 'none';
    }

    function switchSettingsTab(tabName) {
      // Hide all tab contents
      document.querySelectorAll('.settings-tab-content').forEach(content => {
        content.style.display = 'none';
      });

      // Remove active class from all tabs
      document.querySelectorAll('.settings-tab').forEach(tab => {
        tab.style.color = '#6b7280';
        tab.style.borderBottomColor = 'transparent';
        tab.classList.remove('active');
      });

      // Show selected tab content
      document.getElementById(tabName + '-tab-content').style.display = 'block';

      // Add active class to selected tab
      const activeTab = document.querySelector(`.settings-tab[data-tab="${tabName}"]`);
      if (activeTab) {
        activeTab.style.color = '#00FFFF';
        activeTab.style.borderBottomColor = '#00FFFF';
        activeTab.classList.add('active');
      }

      // Load notification recipients when notifications tab is opened
      if (tabName === 'notifications') {
        loadNotificationRecipients();
      }
    }

    function clearPasswordFields() {
      document.getElementById('current-password').value = '';
      document.getElementById('new-password').value = '';
      document.getElementById('confirm-password').value = '';
    }

    // ============ NOTIFICATION RECIPIENTS FUNCTIONS ============
    let notificationRecipients = [];

    async function loadNotificationRecipients() {
      const container = document.getElementById('notification-recipients-container');
      container.innerHTML = '<div style="text-align: center; padding: 40px; color: #9ca3af;"><p>Loading notification settings...</p></div>';

      try {
        const agentId = currentUser.agent_ids[0];
        const res = await fetch(`/api/notification-recipients/${agentId}`);
        if (!res.ok) throw new Error('Failed to load recipients');

        const data = await res.json();
        notificationRecipients = data.recipients || [];
        renderNotificationRecipients();
      } catch (error) {
        console.error('Error loading notification recipients:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 40px; color: #f85149;">
            <p>Failed to load notification settings</p>
            <button onclick="loadNotificationRecipients()" style="margin-top: 16px; padding: 8px 16px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 6px; cursor: pointer;">Retry</button>
          </div>
        `;
      }
    }

    function renderNotificationRecipients() {
      const container = document.getElementById('notification-recipients-container');

      if (notificationRecipients.length === 0) {
        container.innerHTML = `
          <div style="text-align: center; padding: 60px 20px; background: rgba(13, 17, 23, 0.4); border: 1px dashed rgba(0, 255, 255, 0.3); border-radius: 12px;">
            <div style="font-size: 48px; margin-bottom: 16px;"></div>
            <h4 style="color: #e6edf3; font-size: 16px; margin-bottom: 8px;">No notification recipients configured</h4>
            <p style="color: #9ca3af; font-size: 13px; margin-bottom: 20px;">Add team members to receive email and SMS notifications for calls.</p>
            <button onclick="openAddNotificationRecipient()" style="padding: 10px 20px; background: linear-gradient(135deg, rgba(0, 255, 255, 0.2), rgba(0, 200, 200, 0.2)); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; cursor: pointer; font-size: 12px; font-weight: 700; text-transform: uppercase;">+ Add Your First Recipient</button>
          </div>
        `;
        return;
      }

      const categories = ['New Lead', 'Existing Client', 'Attorney', 'Insurance', 'Medical', 'Other'];
      const categoryKeys = {
        'New Lead': 'new_lead',
        'Existing Client': 'existing_client',
        'Attorney': 'attorney',
        'Insurance': 'insurance',
        'Medical': 'medical',
        'Other': 'other'
      };

      let html = '';

      notificationRecipients.forEach(recipient => {
        html += `
          <div style="background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(0, 255, 255, 0.2); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 16px;">
              <div>
                <h4 style="color: #e6edf3; font-size: 16px; font-weight: 700; margin: 0 0 4px 0;">${recipient.name}</h4>
                <div style="font-size: 13px; color: #00FFFF; font-family: 'JetBrains Mono', monospace;">${recipient.email}</div>
                ${recipient.phone ? `<div style="font-size: 12px; color: #9ca3af; margin-top: 2px;"> ${recipient.phone}</div>` : '<div style="font-size: 12px; color: #6b7280; margin-top: 2px;">No phone (SMS disabled)</div>'}
              </div>
              <button onclick="deleteNotificationRecipient(${recipient.id}, '${recipient.name}')" style="padding: 6px 12px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; cursor: pointer; font-size: 11px; font-weight: 600;">Remove</button>
            </div>

            <div style="overflow-x: auto;">
              <table style="width: 100%; border-collapse: collapse; font-size: 13px;">
                <thead>
                  <tr style="border-bottom: 1px solid rgba(0, 255, 255, 0.2);">
                    <th style="text-align: left; padding: 8px 12px; color: #9ca3af; font-weight: 600; font-size: 11px; text-transform: uppercase;">Category</th>
                    <th style="text-align: center; padding: 8px 12px; color: #9ca3af; font-weight: 600; font-size: 11px; text-transform: uppercase;">Email</th>
                    <th style="text-align: center; padding: 8px 12px; color: #9ca3af; font-weight: 600; font-size: 11px; text-transform: uppercase;">SMS</th>
                  </tr>
                </thead>
                <tbody>
        `;

        categories.forEach(category => {
          const key = categoryKeys[category];
          const emailEnabled = recipient[`${key}_email`] !== false;
          const smsEnabled = recipient[`${key}_sms`] === true;
          const smsDisabled = !recipient.phone;

          html += `
            <tr style="border-bottom: 1px solid rgba(48, 54, 61, 0.5);">
              <td style="padding: 10px 12px; color: #e6edf3;">${category}</td>
              <td style="text-align: center; padding: 10px 12px;">
                <label style="cursor: pointer;">
                  <input type="checkbox" ${emailEnabled ? 'checked' : ''} onchange="updateRecipientPreference(${recipient.id}, '${key}_email', this.checked)" style="cursor: pointer; width: 18px; height: 18px; accent-color: #00FFFF;">
                </label>
              </td>
              <td style="text-align: center; padding: 10px 12px;">
                <label style="cursor: ${smsDisabled ? 'not-allowed' : 'pointer'}; opacity: ${smsDisabled ? '0.4' : '1'};">
                  <input type="checkbox" ${smsEnabled ? 'checked' : ''} ${smsDisabled ? 'disabled' : ''} onchange="updateRecipientPreference(${recipient.id}, '${key}_sms', this.checked)" style="cursor: ${smsDisabled ? 'not-allowed' : 'pointer'}; width: 18px; height: 18px; accent-color: #00FFFF;">
                </label>
              </td>
            </tr>
          `;
        });

        html += `
                </tbody>
              </table>
            </div>
          </div>
        `;
      });

      container.innerHTML = html;
    }

    function openAddNotificationRecipient() {
      document.getElementById('recipient-name').value = '';
      document.getElementById('recipient-email').value = '';
      document.getElementById('recipient-phone').value = '';
      document.getElementById('add-recipient-modal').style.display = 'block';
    }

    function closeAddRecipientModal() {
      document.getElementById('add-recipient-modal').style.display = 'none';
    }

    async function saveNotificationRecipient(event) {
      event.preventDefault();

      const name = document.getElementById('recipient-name').value.trim();
      const email = document.getElementById('recipient-email').value.trim();
      const phone = document.getElementById('recipient-phone').value.trim();
      const btn = document.getElementById('save-recipient-btn');

      if (!name || !email) {
        showToast('Name and email are required', 'error');
        return;
      }

      btn.textContent = 'Adding...';
      btn.disabled = true;

      try {
        const agentId = currentUser.agent_ids[0];
        const res = await fetch('/api/notification-recipients', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ agent_id: agentId, name, email, phone: phone || null })
        });

        const data = await res.json();

        if (!res.ok) {
          throw new Error(data.error || 'Failed to add recipient');
        }

        showToast(`${name} added as notification recipient`, 'success');
        closeAddRecipientModal();
        loadNotificationRecipients();
      } catch (error) {
        showToast(error.message, 'error');
      } finally {
        btn.textContent = 'Add Recipient';
        btn.disabled = false;
      }
    }

    async function updateRecipientPreference(recipientId, field, value) {
      try {
        const res = await fetch(`/api/notification-preferences/${recipientId}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ [field]: value })
        });

        if (!res.ok) {
          throw new Error('Failed to update preference');
        }

        // Update local state
        const recipient = notificationRecipients.find(r => r.id === recipientId);
        if (recipient) {
          recipient[field] = value;
        }

        console.log(`Updated ${field} = ${value} for recipient ${recipientId}`);
      } catch (error) {
        showToast('Failed to update preference', 'error');
        loadNotificationRecipients(); // Reload to reset checkboxes
      }
    }

    async function deleteNotificationRecipient(recipientId, name) {
      if (!confirm(`Remove ${name} from notification recipients?`)) return;

      try {
        const res = await fetch(`/api/notification-recipients/${recipientId}`, {
          method: 'DELETE'
        });

        if (!res.ok) {
          throw new Error('Failed to remove recipient');
        }

        showToast(`${name} removed from notifications`, 'success');
        loadNotificationRecipients();
      } catch (error) {
        showToast(error.message, 'error');
      }
    }

    // ============ END NOTIFICATION RECIPIENTS FUNCTIONS ============

    async function saveSettings(event) {
      event.preventDefault();

      const currentPassword = document.getElementById('current-password').value;
      const newPassword = document.getElementById('new-password').value;
      const confirmPassword = document.getElementById('confirm-password').value;

      // If no password fields are filled, just close
      if (!currentPassword && !newPassword && !confirmPassword) {
        closeSettingsModal();
        return;
      }

      // Validate password fields
      if (!currentPassword) {
        showToast('Please enter your current password', 'error');
        return;
      }

      if (!newPassword) {
        showToast('Please enter a new password', 'error');
        return;
      }

      if (newPassword.length < 8) {
        showToast('New password must be at least 8 characters', 'error');
        return;
      }

      if (newPassword !== confirmPassword) {
        showToast('Passwords do not match', 'error');
        return;
      }

      const saveBtn = document.getElementById('save-settings-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const response = await fetch('/api/auth/change-password', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify({
            currentPassword,
            newPassword
          })
        });

        const data = await response.json();

        if (response.ok) {
          showToast('Password changed successfully!', 'success');
          closeSettingsModal();
        } else {
          showToast(data.error || 'Failed to change password', 'error');
        }
      } catch (error) {
        console.error('Settings save error:', error);
        showToast('Network error. Please try again.', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Changes';
      }
    }

    // ============ TEAM MEMBER MANAGEMENT FUNCTIONS ============

    // Load team members from backend
    async function loadTeamMembers() {
      try {
        const response = await fetch('/api/team/members', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          renderTeamMembers(data.members);
        } else {
          console.error('Failed to load team members');
        }
      } catch (error) {
        console.error('Error loading team members:', error);
      }
    }

    // Render team members in table
    function renderTeamMembers(members) {
      const tbody = document.getElementById('team-members-tbody-settings');

      if (!members || members.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="6" style="text-align: center; padding: 40px; color: #9ca3af;">No team members yet. Add one to get started!</td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = members.map(member => {
        const lastLogin = member.last_login
          ? new Date(member.last_login).toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })
          : 'Never';

        const statusColor = member.active ? '#10b981' : '#ef4444';
        const statusText = member.active ? 'Active' : 'Inactive';

        return `
          <tr style="border-bottom: 1px solid rgba(55, 65, 81, 0.5);">
            <td style="padding: 20px; color: #e6edf3; font-weight: 600;">${escapeHtml(member.name)}</td>
            <td style="padding: 20px; color: #9ca3af; font-family: 'JetBrains Mono', monospace; font-size: 13px;">${escapeHtml(member.email)}</td>
            <td style="padding: 20px;">
              <span style="padding: 6px 14px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 6px; font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1px;">
                ${escapeHtml(member.role)}
              </span>
            </td>
            <td style="padding: 20px; color: #9ca3af; font-size: 13px;">${lastLogin}</td>
            <td style="padding: 20px;">
              <span style="display: inline-block; width: 8px; height: 8px; background: ${statusColor}; border-radius: 50%; margin-right: 8px; box-shadow: 0 0 8px ${statusColor};"></span>
              <span style="color: ${statusColor}; font-weight: 600; font-size: 13px;">${statusText}</span>
            </td>
            <td style="padding: 20px;">
              <button onclick="editTeamMember(${member.id})" style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 6px; cursor: pointer; font-size: 12px; margin-right: 8px;">
                Edit
              </button>
              <button onclick="deleteTeamMember(${member.id})" style="padding: 8px 16px; background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.3); border-radius: 6px; cursor: pointer; font-size: 12px;">
                Remove
              </button>
            </td>
          </tr>
        `;
      }).join('');
    }

    // Open modal to add new team member
    function openAddTeamMember() {
      document.getElementById('team-modal-title').textContent = 'Add Team Member';
      document.getElementById('team-member-id').value = '';
      document.getElementById('team-member-name').value = '';
      document.getElementById('team-member-email').value = '';
      document.getElementById('team-member-role').value = 'Viewer';
      document.getElementById('team-member-password').value = '';
      document.getElementById('team-member-password').required = true;
      document.getElementById('password-section').querySelector('label').textContent = 'Initial Password';
      document.getElementById('team-member-modal').style.display = 'block';
    }

    // Edit existing team member
    async function editTeamMember(id) {
      try {
        const response = await fetch('/api/team/members', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          const member = data.members.find(m => m.id === id);

          if (member) {
            document.getElementById('team-modal-title').textContent = 'Edit Team Member';
            document.getElementById('team-member-id').value = member.id;
            document.getElementById('team-member-name').value = member.name;
            document.getElementById('team-member-email').value = member.email;
            document.getElementById('team-member-role').value = member.role;
            document.getElementById('team-member-password').value = '';
            document.getElementById('team-member-password').required = false;
            document.getElementById('password-section').querySelector('label').textContent = 'New Password (leave blank to keep current)';
            document.getElementById('team-member-modal').style.display = 'block';
          }
        }
      } catch (error) {
        console.error('Error loading team member:', error);
        showToast('Failed to load team member details', 'error');
      }
    }

    // Close team member modal
    function closeTeamMemberModal() {
      document.getElementById('team-member-modal').style.display = 'none';
    }

    // Save team member (create or update)
    async function saveTeamMember(event) {
      event.preventDefault();

      const id = document.getElementById('team-member-id').value;
      const name = document.getElementById('team-member-name').value;
      const email = document.getElementById('team-member-email').value;
      const role = document.getElementById('team-member-role').value;
      const password = document.getElementById('team-member-password').value;

      // Validation
      if (!id && password.length < 8) {
        showToast('Password must be at least 8 characters', 'error');
        return;
      }

      const saveBtn = document.getElementById('save-team-member-btn');
      saveBtn.disabled = true;
      saveBtn.textContent = 'Saving...';

      try {
        const body = { email, name, role };
        if (password) {
          body.password = password;
        }

        const url = id ? `/api/team/members/${id}` : '/api/team/members';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include',
          body: JSON.stringify(body)
        });

        const data = await response.json();

        if (response.ok) {
          showToast(id ? 'Team member updated successfully!' : 'Team member added successfully!', 'success');
          closeTeamMemberModal();
          loadTeamMembers(); // Reload the list
        } else {
          showToast(data.error || 'Failed to save team member', 'error');
        }
      } catch (error) {
        console.error('Error saving team member:', error);
        showToast('Network error. Please try again.', 'error');
      } finally {
        saveBtn.disabled = false;
        saveBtn.textContent = 'Save Member';
      }
    }

    // Delete team member
    async function deleteTeamMember(id) {
      if (!confirm('Are you sure you want to remove this team member? They will no longer have access to the dashboard.')) {
        return;
      }

      try {
        const response = await fetch(`/api/team/members/${id}`, {
          method: 'DELETE',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        const data = await response.json();

        if (response.ok) {
          showToast('Team member removed successfully', 'success');
          loadTeamMembers(); // Reload the list
        } else {
          showToast(data.error || 'Failed to remove team member', 'error');
        }
      } catch (error) {
        console.error('Error deleting team member:', error);
        showToast('Network error. Please try again.', 'error');
      }
    }

    // ============ ACTIVITY LOG & TEAM METRICS FUNCTIONS ============

    // Load activity log
    async function loadActivityLog() {
      try {
        const response = await fetch('/api/activity', {
          method: 'GET',
          headers: {
            'Content-Type': 'application/json'
          },
          credentials: 'include'
        });

        if (response.ok) {
          const data = await response.json();
          renderActivityLog(data.activities);
          // Activity log is now part of team-section, no separate display needed
        }
      } catch (error) {
        console.error('Error loading activity log:', error);
      }
    }

    // Render activity log
    function renderActivityLog(activities) {
      const tbody = document.getElementById('activity-log-tbody-settings');

      if (!activities || activities.length === 0) {
        tbody.innerHTML = `
          <tr>
            <td colspan="5" style="text-align: center; padding: 40px; color: #9ca3af;">No activity recorded yet</td>
          </tr>
        `;
        return;
      }

      tbody.innerHTML = activities.map(activity => {
        const actionTime = new Date(activity.created_at);
        const timeAgo = getTimeAgo(actionTime);
        const formattedTime = actionTime.toLocaleString('en-US', {
          month: 'short',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        });

        const actionColor = activity.action === 'login' ? '#10b981' :
                           activity.action === 'export' ? '#3b82f6' :
                           activity.action === 'update_category' ? '#f59e0b' :
                           '#00FFFF';

        const actionText = activity.action.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());

        let detailsText = '';
        if (activity.details) {
          try {
            const details = typeof activity.details === 'string' ? JSON.parse(activity.details) : activity.details;
            if (details.call_id) {
              detailsText = `Call ID: ${details.call_id}`;
            } else if (details.category) {
              detailsText = `Category: ${details.category}`;
            }
          } catch (e) {
            detailsText = '';
          }
        }

        return `
          <tr style="border-bottom: 1px solid rgba(55, 65, 81, 0.5);">
            <td style="padding: 16px 20px; color: #9ca3af; font-size: 13px;" title="${formattedTime}">
              ${timeAgo}
            </td>
            <td style="padding: 16px 20px; color: #e6edf3; font-weight: 600;">
              ${escapeHtml(activity.team_member_name || 'System')}
            </td>
            <td style="padding: 16px 20px;">
              <span style="padding: 4px 10px; background: rgba(0, 255, 255, 0.1); color: #00FFFF; border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 4px; font-size: 11px; font-weight: 600; text-transform: uppercase;">
                ${escapeHtml(activity.team_member_role || 'N/A')}
              </span>
            </td>
            <td style="padding: 16px 20px;">
              <span style="display: inline-flex; align-items: center; gap: 6px;">
                <span style="width: 6px; height: 6px; background: ${actionColor}; border-radius: 50%; box-shadow: 0 0 6px ${actionColor};"></span>
                <span style="color: #e6edf3; font-weight: 500; font-size: 13px;">${actionText}</span>
              </span>
            </td>
            <td style="padding: 16px 20px; color: #9ca3af; font-size: 13px; font-family: 'JetBrains Mono', monospace;">
              ${detailsText}
            </td>
          </tr>
        `;
      }).join('');
    }

    // Helper function to calculate time ago
    function getTimeAgo(date) {
      const now = Date.now();
      const diffMs = now - date.getTime();
      const diffMins = Math.floor(diffMs / 60000);
      const diffHours = Math.floor(diffMs / 3600000);
      const diffDays = Math.floor(diffMs / 86400000);

      if (diffMins < 1) return 'Just now';
      if (diffMins < 60) return `${diffMins}m ago`;
      if (diffHours < 24) return `${diffHours}h ago`;
      if (diffDays < 7) return `${diffDays}d ago`;
      return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });
    }

    // Export to CSV
    function exportToCSV() {
      const exportBtn = document.getElementById('export-btn');
      const originalText = exportBtn.innerHTML;
      exportBtn.innerHTML = '<svg fill="none" stroke="currentColor" viewBox="0 0 24 24" style="width: 16px; height: 16px;"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>Exporting...';
      exportBtn.disabled = true;

      try {
        // Get currently filtered calls
        const searchTerm = document.getElementById('search-box').value.toLowerCase();
        const datePreset = document.getElementById('date-preset').value;
        const dateFrom = document.getElementById('date-from').value;
        const dateTo = document.getElementById('date-to').value;

        let callsToExport = [...allCalls];

        // Apply same filters as the table
        if (datePreset !== 'all' && datePreset !== 'custom') {
          const daysAgo = parseInt(datePreset);
          const cutoffDate = Date.now() - (daysAgo * 24 * 60 * 60 * 1000);
          callsToExport = callsToExport.filter(call =>
            call.start_timestamp && call.start_timestamp >= cutoffDate
          );
        } else if (dateFrom || dateTo) {
          const fromTimestamp = dateFrom ? new Date(dateFrom).getTime() : 0;
          const toTimestamp = dateTo ? new Date(dateTo).setHours(23, 59, 59, 999) : Date.now();

          callsToExport = callsToExport.filter(call => {
            if (!call.start_timestamp) return false;
            return call.start_timestamp >= fromTimestamp && call.start_timestamp <= toTimestamp;
          });
        }

        if (selectedCategories.length > 0) {
          callsToExport = callsToExport.filter(call => {
            const callCategory = categories[call.call_id]?.category || 'Uncategorized';
            return selectedCategories.includes(callCategory);
          });
        }

        if (searchTerm) {
          callsToExport = callsToExport.filter(call => {
            const phoneNumber = call.from_number || call.to_number || call.customer_number || '';
            const category = categories[call.call_id]?.category || '';
            return phoneNumber.toLowerCase().includes(searchTerm) ||
                   category.toLowerCase().includes(searchTerm);
          });
        }

        // Create CSV content
        const headers = ['Phone Number', 'Date', 'Duration', 'Status', 'Category', 'Call ID'];
        const csvRows = [headers.join(',')];

        callsToExport.forEach(call => {
          const phoneNumber = call.from_number || call.to_number || call.customer_number || 'N/A';
          const date = call.start_timestamp ? new Date(call.start_timestamp).toLocaleString() : 'N/A';
          const duration = formatDuration(call.duration_minutes || 0);
          const status = call.end_timestamp ? 'completed' : 'ongoing';
          const category = categories[call.call_id]?.category || 'Uncategorized';
          const callId = call.call_id || 'N/A';

          const row = [
            `"${phoneNumber}"`,
            `"${date}"`,
            `"${duration}"`,
            `"${status}"`,
            `"${category}"`,
            `"${callId}"`
          ];
          csvRows.push(row.join(','));
        });

        // Download CSV
        const csvContent = csvRows.join('\n');
        const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
        const link = document.createElement('a');
        const url = URL.createObjectURL(blob);
        const timestamp = new Date().toISOString().split('T')[0];

        link.setAttribute('href', url);
        link.setAttribute('download', `calls-export-${timestamp}.csv`);
        link.style.visibility = 'hidden';
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        showToast('CSV file exported successfully!', 'success');
      } catch (error) {
        console.error('Export error:', error);
        showToast('Failed to export CSV. Please try again.', 'error');
      } finally {
        exportBtn.innerHTML = originalText;
        exportBtn.disabled = false;
      }
    }

    // Refresh dashboard
    async function refreshDashboard() {
      // Show skeleton loading
      document.getElementById('loading').style.display = 'block';
      document.getElementById('dashboard-content').style.display = 'none';

      try {
        // Clear filters for fresh data
        document.getElementById('search-box').value = '';
        document.getElementById('date-preset').value = '30';
        document.getElementById('date-from').value = '';
        document.getElementById('date-to').value = '';
        clearCategoryFilter();

        await loadDashboard();
        showToast('Dashboard refreshed successfully!', 'success');
      } catch (error) {
        console.error('Refresh error:', error);
        showToast('Error refreshing dashboard. Please try again.', 'error');
        // Hide loading and show content even on error
        document.getElementById('loading').style.display = 'none';
        document.getElementById('dashboard-content').style.display = 'block';
      }
    }

    // Advanced Filtering functionality
    let selectedCategories = [];

    function applyQuickDate(period) {
      const dateFrom = document.getElementById('date-from');
      const dateTo = document.getElementById('date-to');
      const datePreset = document.getElementById('date-preset');

      // Get current date in LOCAL timezone
      const now = new Date();
      let startDate = new Date(now); // Clone the date

      switch(period) {
        case 'today':
          // Today: from start of today to end of today (local time)
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'week':
          // This week: from Monday to now
          const dayOfWeek = now.getDay();
          const daysFromMonday = dayOfWeek === 0 ? 6 : dayOfWeek - 1; // Sunday is 0
          startDate.setDate(now.getDate() - daysFromMonday);
          startDate.setHours(0, 0, 0, 0);
          break;
        case 'month':
          // This month: from 1st to now
          startDate.setDate(1);
          startDate.setHours(0, 0, 0, 0);
          break;
      }

      // Format dates as YYYY-MM-DD for input fields using LOCAL timezone
      const formatDate = (date) => {
        const year = date.getFullYear();
        const month = String(date.getMonth() + 1).padStart(2, '0');
        const day = String(date.getDate()).padStart(2, '0');
        return `${year}-${month}-${day}`;
      };

      const fromDateStr = formatDate(startDate);
      const toDateStr = formatDate(now);

      console.log('Quick Date Filter:', period);
      console.log('From Date:', fromDateStr, '(timestamp:', startDate.getTime(), ')');
      console.log('To Date:', toDateStr, '(timestamp:', now.getTime(), ')');

      dateFrom.value = fromDateStr;
      dateTo.value = toDateStr;
      datePreset.value = 'custom';

      filterCalls();
    }

    function applyDatePreset() {
      const preset = document.getElementById('date-preset').value;
      const dateFrom = document.getElementById('date-from');
      const dateTo = document.getElementById('date-to');

      if (preset !== 'custom') {
        dateFrom.value = '';
        dateTo.value = '';
      }

      filterCalls();
    }

    function onDateRangeChange() {
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;

      if (dateFrom || dateTo) {
        document.getElementById('date-preset').value = 'custom';
      }

      filterCalls();
    }

    function toggleCategoryDropdown() {
      const dropdown = document.getElementById('category-dropdown');
      dropdown.style.display = dropdown.style.display === 'none' ? 'block' : 'none';
    }

    function updateCategoryFilter() {
      const checkboxes = document.querySelectorAll('#category-dropdown input[type="checkbox"]');
      selectedCategories = Array.from(checkboxes)
        .filter(cb => cb.checked)
        .map(cb => cb.value);

      const buttonText = document.getElementById('category-button-text');
      if (selectedCategories.length === 0) {
        buttonText.textContent = 'All Categories';
      } else if (selectedCategories.length === 1) {
        buttonText.textContent = selectedCategories[0];
      } else {
        buttonText.textContent = `${selectedCategories.length} Categories`;
      }

      filterCalls();
    }

    function clearCategoryFilter() {
      const checkboxes = document.querySelectorAll('#category-dropdown input[type="checkbox"]');
      checkboxes.forEach(cb => cb.checked = false);
      updateCategoryFilter();
    }

    function filterCalls() {
      const searchTerm = document.getElementById('search-box').value.toLowerCase();
      const datePreset = document.getElementById('date-preset').value;
      const dateFrom = document.getElementById('date-from').value;
      const dateTo = document.getElementById('date-to').value;

      // Reset to page 1 when filtering
      currentPage = 1;

      let filteredCalls = [...allCalls];

      // Apply date filter (preset or custom range)
      if (datePreset !== 'all' && datePreset !== 'custom') {
        const daysAgo = parseInt(datePreset);
        const cutoffDate = Date.now() - (daysAgo * 24 * 60 * 60 * 1000);
        filteredCalls = filteredCalls.filter(call =>
          call.start_timestamp && call.start_timestamp >= cutoffDate
        );
      } else if (dateFrom || dateTo) {
        // Parse dates in local timezone (not UTC) to avoid timezone offset bugs
        const fromTimestamp = dateFrom ? (() => {
          const [year, month, day] = dateFrom.split('-').map(Number);
          return new Date(year, month - 1, day, 0, 0, 0, 0).getTime();
        })() : 0;

        const toTimestamp = dateTo ? (() => {
          const [year, month, day] = dateTo.split('-').map(Number);
          return new Date(year, month - 1, day, 23, 59, 59, 999).getTime();
        })() : Date.now();

        console.log('Filtering calls with date range:');
        console.log('  From:', dateFrom, ' timestamp:', fromTimestamp, '', new Date(fromTimestamp).toLocaleString());
        console.log('  To:', dateTo, ' timestamp:', toTimestamp, '', new Date(toTimestamp).toLocaleString());
        console.log('  Total calls before filter:', filteredCalls.length);

        filteredCalls = filteredCalls.filter(call => {
          if (!call.start_timestamp) return false;
          const matches = call.start_timestamp >= fromTimestamp && call.start_timestamp <= toTimestamp;
          if (matches) {
            console.log('   Call matches:', call.call_id, 'timestamp:', call.start_timestamp, '', new Date(call.start_timestamp).toLocaleString());
          }
          return matches;
        });

        console.log('  Total calls after filter:', filteredCalls.length);
      }

      // Apply multi-category filter
      if (selectedCategories.length > 0) {
        filteredCalls = filteredCalls.filter(call => {
          const callCategory = categories[call.call_id]?.category || 'Uncategorized';
          return selectedCategories.includes(callCategory);
        });
      }

      // Apply duration filter
      const durationFilter = document.getElementById('duration-filter')?.value || 'all';
      if (durationFilter !== 'all') {
        filteredCalls = filteredCalls.filter(call => {
          const durationMinutes = call.duration_minutes || 0;
          const durationSeconds = durationMinutes * 60;

          switch (durationFilter) {
            case 'under30s':
              return durationSeconds < 30;
            case 'under1m':
              return durationSeconds < 60;
            case 'over1m':
              return durationSeconds >= 60;
            case 'over2m':
              return durationSeconds >= 120;
            case 'over5m':
              return durationSeconds >= 300;
            default:
              return true;
          }
        });
      }

      // Apply search filter
      if (searchTerm) {
        filteredCalls = filteredCalls.filter(call => {
          const phoneNumber = call.from_number || call.to_number || call.customer_number || '';
          const category = categories[call.call_id]?.category || '';
          return phoneNumber.toLowerCase().includes(searchTerm) ||
                 category.toLowerCase().includes(searchTerm);
        });
      }

      renderCallsTable(filteredCalls);
    }

    // Add event listeners
    document.getElementById('search-box').addEventListener('input', filterCalls);

    // Close dropdown when clicking outside
    document.addEventListener('click', (e) => {
      const dropdown = document.getElementById('category-dropdown');
      const button = document.getElementById('category-button');
      if (dropdown && button && !button.contains(e.target) && !dropdown.contains(e.target)) {
        dropdown.style.display = 'none';
      }
    });

    // Close modal on click outside
    window.onclick = function(event) {
      const modal = document.getElementById('call-modal');
      if (event.target === modal) {
        closeModal();
      }
    };

    // Keyboard shortcuts
    document.addEventListener('keydown', (e) => {
      // Don't trigger shortcuts when typing in inputs
      if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
        // ESC to blur input
        if (e.key === 'Escape') {
          e.target.blur();
        }
        return;
      }

      // ESC - Close modal
      if (e.key === 'Escape') {
        closeModal();
        return;
      }

      // / - Focus search
      if (e.key === '/') {
        e.preventDefault();
        document.getElementById('search-box').focus();
        return;
      }

      // R - Refresh dashboard
      if (e.key === 'r' || e.key === 'R') {
        e.preventDefault();
        refreshDashboard();
        return;
      }

      // E - Export CSV
      if (e.key === 'e' || e.key === 'E') {
        e.preventDefault();
        exportToCSV();
        return;
      }

      // Arrow Left - Previous page
      if (e.key === 'ArrowLeft' && filteredCalls.length > itemsPerPage) {
        e.preventDefault();
        changePage(-1);
        return;
      }

      // Arrow Right - Next page
      if (e.key === 'ArrowRight' && filteredCalls.length > itemsPerPage) {
        e.preventDefault();
        changePage(1);
        return;
      }
    });

    // Show keyboard shortcuts hint on first load
    setTimeout(() => {
      const hasSeenHint = localStorage.getItem('keyboard-shortcuts-seen');
      if (!hasSeenHint) {
        showToast('Tip: Press / to search, R to refresh, E to export,   for pagination', 'info', 6000);
        localStorage.setItem('keyboard-shortcuts-seen', 'true');
      }
    }, 2000);

    // Onboarding Tour - Professional guided walkthrough
    let tourStep = 0;
    const tourSteps = [
      {
        title: 'Welcome to Your Dashboard! ',
        text: 'This is your <strong>AI-powered call center</strong>. Every call to your business is answered by AI, transcribed, and categorized automatically. Let me show you around!',
        target: null,
        position: 'center',
        icon: ''
      },
      {
        title: 'Your Numbers at a Glance',
        text: 'These 4 cards show your <strong>key metrics</strong>:<br><br> <strong>Total Calls</strong> - All calls received<br> <strong>New Leads</strong> - Potential new clients<br> <strong>Existing Clients</strong> - Your current clients calling back<br> <strong>Other Calls</strong> - Everything else (vendors, wrong numbers, etc.)',
        target: '.stats-grid',
        position: 'bottom',
        arrow: 'top',
        icon: ''
      },
      {
        title: 'Call Activity Charts',
        text: 'See your <strong>call volume trends</strong> over the past week and how calls break down by category. This helps you spot busy days and understand your call mix.',
        target: '.analytics-section',
        position: 'bottom',
        arrow: 'top',
        icon: ''
      },
      {
        title: ' Lead Tracker - Your Action Center',
        text: 'This is the <strong>most important section!</strong> When someone calls about a potential case, they appear here as a pending lead.<br><br> Click <strong style="color: #10b981;"> APPROVE</strong> to mark them as a real lead<br> Click <strong style="color: #ef4444;"> DENY</strong> if it\'s not a valid lead<br><br>You\'ll get notified when new leads come in!',
        target: '#lead-tracker-section',
        position: 'bottom',
        arrow: 'top',
        icon: ''
      },
      {
        title: 'Filter Your Leads',
        text: 'Use these tabs to quickly filter leads:<br><br> <strong> Pending</strong> - Needs your review<br> <strong> Approved</strong> - Confirmed leads<br> <strong> Denied</strong> - Rejected calls',
        target: '#tab-pending',
        position: 'bottom',
        arrow: 'top',
        icon: ''
      },
      {
        title: 'Complete Call History',
        text: 'Every single call is logged here. You can:<br><br> <strong>Search</strong> by phone number or keyword<br> <strong>Filter</strong> by date, category, or duration<br> <strong>Click any row</strong> to see the full transcript and AI summary',
        target: '#recent-calls-section',
        position: 'top',
        arrow: 'bottom',
        icon: ''
      },
      {
        title: 'Filter by Date & Category',
        text: 'Use these filters to find specific calls:<br><br> <strong>Date Presets</strong> - Today, This Week, This Month<br> <strong>Custom Range</strong> - Pick any date range<br> <strong>Category</strong> - Filter by call type<br> <strong>Duration</strong> - Find short or long calls',
        target: '#filters-section',
        position: 'bottom',
        arrow: 'top',
        icon: ''
      },
      {
        title: 'You\'re Ready! ',
        text: 'That\'s everything you need to know!<br><br><strong>Quick tips:</strong><br> Check the Lead Tracker daily for new leads<br> Click any call row to read the full conversation<br> Use filters to find specific calls<br><br>Need help? Contact your SaveYa support team.',
        target: null,
        position: 'center',
        icon: ''
      }
    ];

    function showOnboarding() {
      // Add tour CSS
      if (!document.getElementById('tour-styles')) {
        const tourStyles = document.createElement('style');
        tourStyles.id = 'tour-styles';
        tourStyles.textContent = `
          @keyframes tourGlow {
            0%, 100% { box-shadow: 0 0 20px 5px rgba(0, 255, 255, 0.5), inset 0 0 0 2px rgba(0, 255, 255, 0.8); }
            50% { box-shadow: 0 0 30px 10px rgba(0, 255, 255, 0.3), inset 0 0 0 2px rgba(0, 255, 255, 0.6); }
          }
          @keyframes tourBounce {
            0%, 100% { transform: translateY(0); }
            50% { transform: translateY(-8px); }
          }
          .tour-highlight {
            position: relative;
            z-index: 10001 !important;
            animation: tourGlow 1.5s ease-in-out infinite !important;
            border-radius: 12px !important;
          }
        `;
        document.head.appendChild(tourStyles);
      }

      // Remove any existing tour elements to prevent duplicates
      const existingOverlay = document.getElementById('tour-overlay');
      const existingTooltip = document.getElementById('tour-tooltip');
      if (existingOverlay) existingOverlay.remove();
      if (existingTooltip) existingTooltip.remove();
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

      // Create overlay - lighter so content is visible
      const overlay = document.createElement('div');
      overlay.id = 'tour-overlay';
      overlay.style.cssText = `
        position: fixed;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        background: rgba(0, 0, 0, 0.5);
        z-index: 10000;
        opacity: 0;
        transition: opacity 0.3s ease;
        pointer-events: none;
      `;

      // Create tooltip - mobile responsive
      const tooltip = document.createElement('div');
      tooltip.id = 'tour-tooltip';
      const isMobile = window.innerWidth < 768;
      tooltip.style.cssText = `
        position: fixed;
        background: rgba(13, 17, 23, 0.98);
        backdrop-filter: blur(20px);
        border: 2px solid #00FFFF;
        border-radius: 16px;
        padding: ${isMobile ? '20px' : '24px'};
        width: ${isMobile ? 'calc(100% - 24px)' : '400px'};
        max-width: 400px;
        z-index: 10002;
        box-shadow: 0 8px 32px rgba(0, 255, 255, 0.3), 0 0 0 1px rgba(255, 255, 255, 0.1);
        opacity: 0;
        transition: opacity 0.3s ease, transform 0.3s ease;
        transform: translateY(10px);
        pointer-events: auto;
      `;

      document.body.appendChild(overlay);
      document.body.appendChild(tooltip);

      setTimeout(() => {
        overlay.style.opacity = '1';
        tooltip.style.opacity = '1';
        tooltip.style.transform = 'translateY(0)';
      }, 10);

      showTourStep(0, tooltip, overlay);
    }

    function showTourStep(step, tooltip, overlay) {
      if (step >= tourSteps.length) {
        closeTour(tooltip, overlay);
        return;
      }

      const currentStep = tourSteps[step];
      const isMobile = window.innerWidth < 768;

      // Build progress dots
      const progressDots = tourSteps.map((_, i) =>
        `<div style="width: ${i === step ? '20px' : '6px'}; height: 6px; border-radius: 3px; background: ${i === step ? '#00FFFF' : i < step ? 'rgba(0, 255, 255, 0.5)' : 'rgba(255, 255, 255, 0.2)'}; transition: all 0.3s;"></div>`
      ).join('');

      tooltip.innerHTML = `
        <div style="margin-bottom: ${isMobile ? '12px' : '16px'};">
          <!-- Progress indicator -->
          <div style="display: flex; align-items: center; gap: 4px; margin-bottom: 12px;">
            ${progressDots}
            <span style="margin-left: auto; color: #9ca3af; font-size: 11px; font-weight: 600;">${step + 1} of ${tourSteps.length}</span>
          </div>

          <!-- Icon and Title -->
          <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
            ${currentStep.icon ? `<span style="font-size: ${isMobile ? '24px' : '28px'}; line-height: 1;">${currentStep.icon}</span>` : ''}
            <h3 style="color: #00FFFF; font-size: ${isMobile ? '16px' : '18px'}; font-weight: 700; margin: 0; line-height: 1.3;">
              ${currentStep.title}
            </h3>
          </div>

          <!-- Description -->
          <div style="color: #e6edf3; font-size: ${isMobile ? '13px' : '14px'}; line-height: 1.6; margin: 0;">
            ${currentStep.text}
          </div>
        </div>

        <!-- Look Here indicator for targeted steps -->
        ${currentStep.target ? `
          <div style="display: flex; align-items: center; gap: 8px; padding: 8px 12px; background: rgba(0, 255, 255, 0.15); border: 1px solid rgba(0, 255, 255, 0.4); border-radius: 8px; margin-bottom: 12px;">
            <span style="font-size: 16px; animation: tourBounce 1s infinite;"></span>
            <span style="color: #00FFFF; font-size: 12px; font-weight: 600;">Look at the highlighted section</span>
          </div>
        ` : ''}

        <!-- Don't show again checkbox - ALWAYS visible -->
        <div style="margin-bottom: 12px; padding: 8px 10px; background: rgba(0, 0, 0, 0.3); border-radius: 8px;">
          <label style="display: flex; align-items: center; cursor: pointer; color: #9ca3af; font-size: 12px;">
            <input type="checkbox" id="dont-show-tour-again" style="width: 16px; height: 16px; margin-right: 8px; cursor: pointer; accent-color: #00FFFF; flex-shrink: 0;">
            <span>Don't show this tour again</span>
          </label>
        </div>

        <!-- Buttons -->
        <div style="display: flex; gap: 8px;">
          <button onclick="skipTour()" style="flex: 1; padding: ${isMobile ? '12px' : '14px'}; background: rgba(239, 68, 68, 0.15); color: #f87171; border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 10px; font-size: 13px; font-weight: 600; cursor: pointer; transition: all 0.2s;">
             Skip
          </button>
          <button onclick="nextTourStep()" style="flex: 2; padding: ${isMobile ? '12px' : '14px'}; background: linear-gradient(135deg, #00FFFF, #00CED1); color: #0d1117; border: none; border-radius: 10px; font-size: 13px; font-weight: 700; cursor: pointer; transition: all 0.2s; box-shadow: 0 4px 14px rgba(0, 255, 255, 0.4);">
            ${step === tourSteps.length - 1 ? ' Finish' : 'Next '}
          </button>
        </div>
      `;

      // Remove previous highlights
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

      // Position tooltip
      if (currentStep.target) {
        const targetEl = document.querySelector(currentStep.target);
        if (targetEl) {
          // Add highlight class to target
          targetEl.classList.add('tour-highlight');

          // Scroll element into view
          targetEl.scrollIntoView({ behavior: 'smooth', block: 'center' });

          setTimeout(() => {
            const rect = targetEl.getBoundingClientRect();

            if (isMobile) {
              // Mobile: position at bottom of screen
              tooltip.style.position = 'fixed';
              tooltip.style.bottom = '12px';
              tooltip.style.left = '12px';
              tooltip.style.right = '12px';
              tooltip.style.top = 'auto';
              tooltip.style.transform = 'none';
              tooltip.style.width = 'auto';
              tooltip.style.maxWidth = 'none';
            } else {
              // Desktop: position near target but ensure visibility
              tooltip.style.position = 'fixed';
              tooltip.style.width = '380px';
              tooltip.style.maxWidth = '380px';

              // Try to position below or above the target
              const tooltipHeight = 400; // estimated
              const spaceBelow = window.innerHeight - rect.bottom;
              const spaceAbove = rect.top;

              if (spaceBelow > tooltipHeight + 20) {
                // Position below
                tooltip.style.top = `${rect.bottom + 16}px`;
                tooltip.style.bottom = 'auto';
              } else if (spaceAbove > tooltipHeight + 20) {
                // Position above
                tooltip.style.bottom = `${window.innerHeight - rect.top + 16}px`;
                tooltip.style.top = 'auto';
              } else {
                // Position to the side
                tooltip.style.top = '50%';
                tooltip.style.transform = 'translateY(-50%)';
                tooltip.style.bottom = 'auto';
              }

              // Horizontal positioning
              if (rect.left > window.innerWidth / 2) {
                // Target is on right, position tooltip on left
                tooltip.style.right = `${window.innerWidth - rect.left + 20}px`;
                tooltip.style.left = 'auto';
              } else {
                // Target is on left, position tooltip on right
                tooltip.style.left = `${rect.right + 20}px`;
                tooltip.style.right = 'auto';
              }
            }
          }, 100);
        } else {
          // Fallback: Center the tooltip
          console.warn(`Tour step ${step + 1}: Element "${currentStep.target}" not found.`);
          positionTooltipCenter(tooltip, isMobile);
        }
      } else {
        // Center position for intro/outro
        positionTooltipCenter(tooltip, isMobile);
      }

      tourStep = step;
    }

    function positionTooltipCenter(tooltip, isMobile) {
      if (isMobile) {
        tooltip.style.position = 'fixed';
        tooltip.style.bottom = '12px';
        tooltip.style.left = '12px';
        tooltip.style.right = '12px';
        tooltip.style.top = 'auto';
        tooltip.style.transform = 'none';
        tooltip.style.width = 'auto';
        tooltip.style.maxWidth = 'none';
      } else {
        tooltip.style.position = 'fixed';
        tooltip.style.top = '50%';
        tooltip.style.left = '50%';
        tooltip.style.transform = 'translate(-50%, -50%)';
        tooltip.style.right = 'auto';
        tooltip.style.bottom = 'auto';
        tooltip.style.width = '420px';
        tooltip.style.maxWidth = '420px';
      }
    }

    window.nextTourStep = function() {
      const tooltip = document.getElementById('tour-tooltip');
      const overlay = document.getElementById('tour-overlay');

      // Remove highlight from previous target
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

      showTourStep(tourStep + 1, tooltip, overlay);
    };

    window.skipTour = function() {
      const tooltip = document.getElementById('tour-tooltip');
      const overlay = document.getElementById('tour-overlay');
      closeTour(tooltip, overlay);
    };

    function closeTour(tooltip, overlay) {
      // Check if "don't show again" is checked - THIS WORKS ON ANY STEP NOW
      const dontShowAgain = document.getElementById('dont-show-tour-again');
      if (dontShowAgain && dontShowAgain.checked) {
        localStorage.setItem('dashboard-tour-never-show', 'true');
        console.log('[TOUR] User checked "Don\'t show again" - saving preference');
      }

      // Remove all highlights
      document.querySelectorAll('.tour-highlight').forEach(el => el.classList.remove('tour-highlight'));

      tooltip.style.opacity = '0';
      overlay.style.opacity = '0';

      setTimeout(() => {
        tooltip.remove();
        overlay.remove();
      }, 300);
    }

    // Check if user has seen the tour
    function checkOnboarding() {
      const neverShowAgain = localStorage.getItem('dashboard-tour-never-show');

      console.log('[TOUR] Checking if tour should show...');
      console.log('[TOUR] neverShowAgain:', neverShowAgain);
      console.log('[TOUR] currentUser:', currentUser ? 'SET' : 'NOT SET');

      // Show tour on EVERY login unless they've checked "don't show again"
      if (!neverShowAgain && currentUser) {
        console.log('[TOUR] Starting tour in 1.5 seconds...');
        setTimeout(() => {
          showOnboarding();
        }, 1500);
      } else {
        console.log('[TOUR] Tour blocked. Reason:', !currentUser ? 'No user' : 'User chose not to see again');
      }
    }

    // Add manual tour trigger for testing
    window.startTourManually = function() {
      console.log('[TOUR] Manually starting tour...');
      showOnboarding();
    };

    // Function to manually retake the tour (called from Settings)
    window.retakeTour = function() {
      // Close settings modal
      closeSettingsModal();

      // Clear the "never show again" flag so tour can show
      localStorage.removeItem('dashboard-tour-never-show');

      // Wait a moment then show tour
      setTimeout(() => {
        showOnboarding();
      }, 300);
    };

    // ============================================================================
    // LEAD TRACKING FUNCTIONS
    // ============================================================================

    // Global storage for leads data
    let allLeadsData = [];

    // Pagination state for leads
    let currentPendingPage = 1;
    let currentApprovedPage = 1;
    let currentDeniedPage = 1;
    const LEADS_PER_PAGE = 5;

    // Search state for leads
    let leadsSearchQuery = '';

    async function loadClientLeads() {
      try {
        // Reset pagination and search when reloading leads
        currentPendingPage = 1;
        currentApprovedPage = 1;
        currentDeniedPage = 1;
        leadsSearchQuery = '';
        document.getElementById('leads-search-input').value = '';
        document.getElementById('clear-search-btn').style.display = 'none';

        // Get client's agent IDs from currentUser (already loaded globally)
        if (!currentUser || !currentUser.agent_ids || currentUser.agent_ids.length === 0) {
          document.getElementById('leads-pending-container').innerHTML = '<div style="padding: 40px; text-align: center; color: #7d8590;"><p>No agent configured</p></div>';
          return;
        }

        const agentId = currentUser.agent_ids[0]; // Use first agent ID

        // Fetch leads and stats
        const [leadsRes, statsRes] = await Promise.all([
          fetch(`/api/leads/${agentId}`),
          fetch(`/api/leads/stats/${agentId}`)
        ]);

        if (!leadsRes.ok || !statsRes.ok) {
          throw new Error('Failed to fetch leads data');
        }

        const leadsData = await leadsRes.json();
        const stats = await statsRes.json();
        const allLeads = leadsData.leads || [];

        // Store leads globally for detail modal
        allLeadsData = allLeads;

        // Split leads by status and apply search filter
        const pendingLeads = filterLeadsBySearch(allLeads.filter(l => l.status === 'Pending'));
        const approvedLeads = filterLeadsBySearch(allLeads.filter(l => l.status === 'Approved'));
        const deniedLeads = filterLeadsBySearch(allLeads.filter(l => l.status === 'Denied'));

        // Update stats
        document.getElementById('leads-total').textContent = stats.total_leads || 0;
        document.getElementById('leads-approved').textContent = stats.approved || 0;
        document.getElementById('leads-denied').textContent = stats.denied || 0;
        document.getElementById('leads-conversion-rate').textContent = `${stats.conversion_rate || 0}%`;

        // Update tab counts
        document.getElementById('pending-count').textContent = pendingLeads.length;
        document.getElementById('approved-count').textContent = approvedLeads.length;
        document.getElementById('denied-count').textContent = deniedLeads.length;

        // Show/hide export button
        const exportBtn = document.getElementById('export-leads-btn');
        if (stats.approved > 0) {
          exportBtn.style.display = 'flex';
        } else {
          exportBtn.style.display = 'none';
        }

        // Render all 3 lists
        renderPendingLeads(pendingLeads);
        renderApprovedLeads(approvedLeads);
        renderDeniedLeads(deniedLeads);

      } catch (error) {
        console.error('Error loading leads:', error);
        document.getElementById('leads-pending-container').innerHTML = `
          <div style="padding: 40px; text-align: center;">
            <p style="color: #f85149; font-size: 16px;"> Failed to load leads</p>
            <p style="color: #7d8590; font-size: 14px;">${error.message}</p>
            <button onclick="loadClientLeads()" class="action-btn" style="margin-top: 20px;">Retry</button>
          </div>
        `;
      }
    }

    function switchLeadsTab(tab) {
      // Update tab buttons
      document.querySelectorAll('.leads-tab').forEach(btn => btn.classList.remove('active'));
      document.getElementById(`tab-${tab}`).classList.add('active');

      // Show/hide content
      document.getElementById('leads-pending-container').style.display = tab === 'pending' ? 'block' : 'none';
      document.getElementById('leads-approved-container').style.display = tab === 'approved' ? 'block' : 'none';
      document.getElementById('leads-denied-container').style.display = tab === 'denied' ? 'block' : 'none';
    }

    function handleLeadsSearch(query) {
      leadsSearchQuery = query.toLowerCase().trim();

      // Show/hide clear button
      const clearBtn = document.getElementById('clear-search-btn');
      clearBtn.style.display = leadsSearchQuery ? 'block' : 'none';

      // Reset pagination when searching
      currentPendingPage = 1;
      currentApprovedPage = 1;
      currentDeniedPage = 1;

      // Re-render all tabs with filtered data
      const pendingLeads = filterLeadsBySearch(allLeadsData.filter(l => l.status === 'Pending'));
      const approvedLeads = filterLeadsBySearch(allLeadsData.filter(l => l.status === 'Approved'));
      const deniedLeads = filterLeadsBySearch(allLeadsData.filter(l => l.status === 'Denied'));

      renderPendingLeads(pendingLeads);
      renderApprovedLeads(approvedLeads);
      renderDeniedLeads(deniedLeads);
    }

    function clearLeadsSearch() {
      leadsSearchQuery = '';
      document.getElementById('leads-search-input').value = '';
      document.getElementById('clear-search-btn').style.display = 'none';

      // Reset pagination
      currentPendingPage = 1;
      currentApprovedPage = 1;
      currentDeniedPage = 1;

      // Re-render all tabs without filter
      const pendingLeads = allLeadsData.filter(l => l.status === 'Pending');
      const approvedLeads = allLeadsData.filter(l => l.status === 'Approved');
      const deniedLeads = allLeadsData.filter(l => l.status === 'Denied');

      renderPendingLeads(pendingLeads);
      renderApprovedLeads(approvedLeads);
      renderDeniedLeads(deniedLeads);
    }

    function filterLeadsBySearch(leads) {
      if (!leadsSearchQuery) return leads;

      return leads.filter(lead => {
        const name = (lead.name || '').toLowerCase();
        const phone = (lead.phone_number || '').toLowerCase();
        const email = (lead.email || '').toLowerCase();

        return name.includes(leadsSearchQuery) ||
               phone.includes(leadsSearchQuery) ||
               email.includes(leadsSearchQuery);
      });
    }

    function showLeadDetails(leadId, editMode = false) {
      const lead = allLeadsData.find(l => l.id === leadId);
      if (!lead) {
        showToast('Lead not found', 'error');
        return;
      }

      const statusColors = {
        'Pending': '#FFA500',
        'Approved': '#00FF00',
        'Denied': '#FF0000'
      };

      const statusColor = statusColors[lead.status] || '#7d8590';

      // Create modal content
      const modalContent = `
        <div style="padding: 20px;" id="lead-detail-content">
          <div style="display: flex; justify-content: space-between; align-items: start; margin-bottom: 20px;">
            <div style="flex: 1;">
              ${editMode ? `
                <div style="margin-bottom: 12px;">
                  <label style="display: block; color: #7d8590; font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Name</label>
                  <input type="text" id="edit-lead-name" value="${lead.name || ''}" style="width: 100%; padding: 8px; background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(48, 54, 61, 0.8); border-radius: 6px; color: #e6edf3; font-size: 16px;" />
                </div>
                <div style="margin-bottom: 12px;">
                  <label style="display: block; color: #7d8590; font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Phone Number</label>
                  <input type="tel" id="edit-lead-phone" value="${lead.phone_number || ''}" style="width: 100%; padding: 8px; background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(48, 54, 61, 0.8); border-radius: 6px; color: #00FFFF; font-family: 'JetBrains Mono', monospace; font-size: 14px;" />
                </div>
                <div style="margin-bottom: 12px;">
                  <label style="display: block; color: #7d8590; font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Email</label>
                  <input type="email" id="edit-lead-email" value="${lead.email || ''}" style="width: 100%; padding: 8px; background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(48, 54, 61, 0.8); border-radius: 6px; color: #9ca3af; font-size: 14px;" />
                </div>
              ` : `
                <h3 style="margin: 0 0 8px 0; color: #e6edf3; font-size: 20px;">
                  ${lead.name || 'Unknown Caller'}
                  ${lead.conversion_detected ? '<span style="margin-left: 8px; font-size: 20px;" title="Lead converted to client!"></span>' : ''}
                </h3>
                <div style="font-size: 14px; color: #00FFFF; font-family: 'JetBrains Mono', monospace; margin-bottom: 4px;">
                   ${lead.phone_number || 'N/A'}
                </div>
                ${lead.email ? `<div style="font-size: 14px; color: #00FF00; margin-bottom: 4px;"> ${lead.email}</div>` : '<div style="font-size: 14px; color: #7d8590;"> No email provided</div>'}
                ${lead.incident_date ? `<div style="font-size: 13px; color: #9ca3af; margin-top: 8px;"> Incident Date: ${new Date(lead.incident_date).toLocaleDateString()}</div>` : ''}
                ${lead.incident_location ? `<div style="font-size: 13px; color: #9ca3af; margin-top: 4px;"> Location: ${lead.incident_location}</div>` : ''}
              `}
            </div>
            <div style="text-align: right; margin-left: 20px;">
              ${!editMode ? `
                <button onclick="showLeadDetails(${lead.id}, true)" style="background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; padding: 6px 12px; border-radius: 6px; font-size: 12px; cursor: pointer; margin-bottom: 12px;">
                   Edit
                </button>
              ` : ''}
              <div style="background: ${statusColor}33; color: ${statusColor}; padding: 6px 12px; border-radius: 6px; font-size: 12px; font-weight: 700; margin-bottom: 8px;">
                ${lead.status}
              </div>
              <div style="font-size: 12px; color: #7d8590;">
                First Call: ${new Date(lead.first_call_date).toLocaleDateString()}
              </div>
              ${lead.status_updated_at ? `
                <div style="font-size: 11px; color: ${statusColor}; margin-top: 4px;">
                  ${lead.status === 'Approved' ? '' : lead.status === 'Denied' ? '' : ''} ${lead.status}: ${new Date(lead.status_updated_at).toLocaleDateString()}
                </div>
              ` : ''}
            </div>
          </div>

          <div id="lead-call-summary-${lead.id}" style="background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(0, 255, 255, 0.3); border-radius: 12px; padding: 20px; margin-bottom: 16px;">
            <div style="color: #00FFFF; font-weight: 700; font-size: 13px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
               Call Summary
            </div>
            <div style="color: #7d8590; font-size: 14px;">Loading detailed summary...</div>
          </div>

          ${lead.notes ? `
            <div style="background: rgba(${lead.status === 'Approved' ? '0, 255, 0' : lead.status === 'Denied' ? '255, 0, 0' : '255, 165, 0'}, 0.05); border-left: 3px solid rgba(${lead.status === 'Approved' ? '0, 255, 0' : lead.status === 'Denied' ? '255, 0, 0' : '255, 165, 0'}, 0.3); padding: 12px; border-radius: 6px; margin-bottom: 16px;">
              <div style="color: ${statusColor}; font-weight: 600; font-size: 11px; margin-bottom: 6px;">NOTES</div>
              <div style="color: #9ca3af; font-size: 13px;">${lead.notes}</div>
            </div>
          ` : ''}

          <div id="lead-call-details-container-${lead.id}" style="margin-top: 20px;">
            <div style="text-align: center; padding: 24px;">
              <button onclick="loadLeadCallDetails('${lead.call_id}', ${lead.id})" class="action-btn" style="padding: 12px 24px;">
                 Load Call Recording & Transcript
              </button>
            </div>
          </div>

          ${editMode ? `
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button class="btn-approve" style="flex: 1; padding: 12px; font-size: 14px;" onclick="saveLeadContactInfo(${lead.id})">
                 Save Changes
              </button>
              <button style="flex: 1; padding: 12px; font-size: 14px; background: rgba(255, 255, 255, 0.05); border: 1px solid rgba(255, 255, 255, 0.2); color: #9ca3af; border-radius: 8px; cursor: pointer;" onclick="showLeadDetails(${lead.id}, false)">
                Cancel
              </button>
            </div>
          ` : lead.status === 'Pending' ? `
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button class="btn-approve" style="flex: 1; padding: 12px; font-size: 14px;" onclick="updateClientLeadStatus(${lead.id}, 'Approved'); closeModal();">
                 Approve Lead
              </button>
              <button class="btn-deny" style="flex: 1; padding: 12px; font-size: 14px;" onclick="updateClientLeadStatus(${lead.id}, 'Denied'); closeModal();">
                 Deny Lead
              </button>
            </div>
          ` : lead.status === 'Approved' ? `
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button style="flex: 1; padding: 12px; font-size: 14px; background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); color: #FFA500; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s;" onclick="updateClientLeadStatus(${lead.id}, 'Pending'); closeModal();" onmouseover="this.style.background='rgba(255, 165, 0, 0.2)'" onmouseout="this.style.background='rgba(255, 165, 0, 0.1)'">
                 Return to Pending
              </button>
              <button class="btn-deny" style="flex: 1; padding: 12px; font-size: 14px;" onclick="updateClientLeadStatus(${lead.id}, 'Denied'); closeModal();">
                 Mark as Denied
              </button>
            </div>
          ` : lead.status === 'Denied' ? `
            <div style="display: flex; gap: 12px; margin-top: 20px;">
              <button style="flex: 1; padding: 12px; font-size: 14px; background: rgba(255, 165, 0, 0.1); border: 1px solid rgba(255, 165, 0, 0.3); color: #FFA500; border-radius: 8px; cursor: pointer; font-weight: 700; transition: all 0.3s;" onclick="updateClientLeadStatus(${lead.id}, 'Pending'); closeModal();" onmouseover="this.style.background='rgba(255, 165, 0, 0.2)'" onmouseout="this.style.background='rgba(255, 165, 0, 0.1)'">
                 Return to Pending
              </button>
              <button class="btn-approve" style="flex: 1; padding: 12px; font-size: 14px;" onclick="updateClientLeadStatus(${lead.id}, 'Approved'); closeModal();">
                 Mark as Approved
              </button>
            </div>
          ` : ''}
        </div>
      `;

      showModal('Lead Details', modalContent);

      // Fetch and display the detailed call summary
      loadLeadCallSummary(lead.call_id, lead.id);
    }

    async function loadLeadCallSummary(callId, leadId) {
      const summaryContainer = document.getElementById(`lead-call-summary-${leadId}`);
      if (!summaryContainer) return;

      try {
        const response = await fetch(`/api/calls/${callId}`);
        if (!response.ok) throw new Error('Failed to fetch call');

        const call = await response.json();
        const callSummary = call.call_analysis?.call_summary || null;

        if (callSummary) {
          summaryContainer.innerHTML = `
            <div style="color: #00FFFF; font-weight: 700; font-size: 13px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
               Call Summary
            </div>
            <div style="color: #e6edf3; line-height: 1.7; font-size: 14px;">
              ${callSummary}
            </div>
          `;
        } else {
          summaryContainer.innerHTML = `
            <div style="color: #00FFFF; font-weight: 700; font-size: 13px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
               Call Summary
            </div>
            <div style="color: #7d8590; font-size: 14px;">No summary available for this call.</div>
          `;
        }
      } catch (error) {
        console.error('Error loading call summary:', error);
        summaryContainer.innerHTML = `
          <div style="color: #00FFFF; font-weight: 700; font-size: 13px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 1px;">
             Call Summary
          </div>
          <div style="color: #f85149; font-size: 14px;">Failed to load summary</div>
        `;
      }
    }

    async function loadLeadCallDetails(callId, leadId) {
      const container = document.getElementById(`lead-call-details-container-${leadId}`);

      // Show loading state
      container.innerHTML = `
        <div style="text-align: center; padding: 24px;">
          <div style="color: #7d8590; font-size: 14px;">Loading call details...</div>
        </div>
      `;

      try {
        const response = await fetch(`/api/calls/${callId}`);
        if (!response.ok) throw new Error('Failed to fetch call details');

        const call = await response.json();
        const transcriptData = call.transcript_object || [];
        const recordingUrl = call.recording_url;

        let contentHTML = '';

        // Add recording
        if (recordingUrl) {
          contentHTML += `
            <div style="background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(48, 54, 61, 0.8); border-radius: 8px; padding: 16px; margin-bottom: 16px;">
              <div style="color: #00FFFF; font-weight: 600; font-size: 12px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                 Call Recording
              </div>
              <audio controls style="width: 100%;">
                <source src="${recordingUrl}" type="audio/mpeg">
                Your browser does not support the audio element.
              </audio>
            </div>
          `;
        }

        // Add transcript
        if (transcriptData && transcriptData.length > 0) {
          contentHTML += `
            <div style="background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(48, 54, 61, 0.8); border-radius: 8px; padding: 16px; margin-bottom: 16px; max-height: 500px; overflow-y: auto;">
              <div style="color: #00FFFF; font-weight: 600; font-size: 12px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                 Transcript
              </div>
              ${transcriptData.map(msg => {
                const role = msg.role === 'agent' ? 'AI' : 'Caller';
                const color = msg.role === 'agent' ? '#00FFFF' : '#00FF00';
                const bgColor = msg.role === 'agent' ? 'rgba(0, 255, 255, 0.05)' : 'rgba(0, 255, 0, 0.05)';
                return `
                  <div style="margin-bottom: 16px; padding: 12px; border-left: 3px solid ${color}; background: ${bgColor}; border-radius: 4px;">
                    <div style="color: ${color}; font-weight: 700; font-size: 11px; margin-bottom: 6px; text-transform: uppercase; letter-spacing: 1px;">
                      ${role}
                    </div>
                    <div style="color: #e6edf3; line-height: 1.5; font-size: 14px;">
                      ${msg.content}
                    </div>
                  </div>
                `;
              }).join('')}
            </div>
          `;
        }

        // Add call analysis if available
        if (call.call_analysis) {
          const analysis = call.call_analysis;
          contentHTML += `
            <div style="background: rgba(13, 17, 23, 0.6); border: 1px solid rgba(48, 54, 61, 0.8); border-radius: 8px; padding: 16px;">
              <div style="color: #00FFFF; font-weight: 600; font-size: 12px; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px;">
                 Call Analysis
              </div>
              ${analysis.call_summary ? `
                <div style="margin-bottom: 12px;">
                  <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Summary</div>
                  <div style="color: #e6edf3; font-size: 14px; line-height: 1.6;">${analysis.call_summary}</div>
                </div>
              ` : ''}
              ${analysis.user_sentiment ? `
                <div style="margin-bottom: 12px;">
                  <div style="color: #9ca3af; font-size: 11px; margin-bottom: 4px; text-transform: uppercase;">Caller Sentiment</div>
                  <div style="color: #e6edf3; font-size: 14px;">${analysis.user_sentiment}</div>
                </div>
              ` : ''}
            </div>
          `;
        }

        container.innerHTML = contentHTML || '<div style="text-align: center; padding: 24px; color: #7d8590;">No call details available</div>';

      } catch (error) {
        console.error('Error loading call details:', error);
        container.innerHTML = `
          <div style="text-align: center; padding: 24px;">
            <div style="color: #f85149; margin-bottom: 12px;"> Failed to load call details</div>
            <button onclick="loadLeadCallDetails('${callId}', ${leadId})" class="action-btn" style="padding: 8px 16px; font-size: 13px;">
              Retry
            </button>
          </div>
        `;
      }
    }

    function renderPendingLeads(leads) {
      const container = document.getElementById('leads-pending-container');

      if (leads.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #7d8590;">
            <p style="font-size: 16px;">No pending leads</p>
            <p style="font-size: 14px; margin-top: 10px;">New leads will appear here when calls are categorized as "New Lead"</p>
          </div>
        `;
        return;
      }

      // Pagination logic
      const totalPages = Math.ceil(leads.length / LEADS_PER_PAGE);
      const startIdx = (currentPendingPage - 1) * LEADS_PER_PAGE;
      const endIdx = startIdx + LEADS_PER_PAGE;
      const paginatedLeads = leads.slice(startIdx, endIdx);

      container.innerHTML = `
        <table id="calls-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>First Call</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            ${paginatedLeads.map(lead => `
              <tr style="${lead.conversion_detected ? 'background: rgba(0, 255, 0, 0.05); cursor: pointer;' : 'cursor: pointer;'}" onclick="showLeadDetails(${lead.id})">
                <td>
                  ${lead.name || 'Unknown Caller'}
                  ${lead.conversion_detected ? '<span style="margin-left: 8px; font-size: 18px;" title="Lead converted to client!"></span>' : ''}
                </td>
                <td style="color: #00FFFF; font-family: 'JetBrains Mono', monospace; font-size: 12px;">${lead.phone_number || 'N/A'}</td>
                <td style="color: #7d8590; font-size: 12px;">${lead.email || 'N/A'}</td>
                <td style="color: #7d8590; font-size: 12px;">${new Date(lead.first_call_date).toLocaleDateString()}</td>
                <td onclick="event.stopPropagation()">
                  <button class="btn-approve" style="padding: 8px 16px; font-size: 12px; margin-right: 8px;" onclick="updateClientLeadStatus(${lead.id}, 'Approved')">
                     Approve
                  </button>
                  <button class="btn-deny" style="padding: 8px 16px; font-size: 12px;" onclick="updateClientLeadStatus(${lead.id}, 'Denied')">
                     Deny
                  </button>
                </td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        ${totalPages > 1 ? `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: rgba(13, 17, 23, 0.6); border-radius: 8px;">
            <button
              onclick="currentPendingPage--; renderPendingLeads(allLeadsData.filter(l => l.status === 'Pending'))"
              ${currentPendingPage === 1 ? 'disabled' : ''}
              style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; border-radius: 6px; cursor: pointer; ${currentPendingPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
            >
               Previous
            </button>
            <span style="color: #7d8590; font-size: 14px;">
              Page ${currentPendingPage} of ${totalPages} (${leads.length} total leads)
            </span>
            <button
              onclick="currentPendingPage++; renderPendingLeads(allLeadsData.filter(l => l.status === 'Pending'))"
              ${currentPendingPage === totalPages ? 'disabled' : ''}
              style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; border-radius: 6px; cursor: pointer; ${currentPendingPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
            >
              Next 
            </button>
          </div>
        ` : ''}
      `;
    }

    function renderApprovedLeads(leads) {
      const container = document.getElementById('leads-approved-container');

      if (leads.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #7d8590;">
            <p style="font-size: 16px;">No approved leads yet</p>
            <p style="font-size: 14px; margin-top: 10px;">Leads you approve will appear here for your records</p>
          </div>
        `;
        return;
      }

      // Pagination logic
      const totalPages = Math.ceil(leads.length / LEADS_PER_PAGE);
      const startIdx = (currentApprovedPage - 1) * LEADS_PER_PAGE;
      const endIdx = startIdx + LEADS_PER_PAGE;
      const paginatedLeads = leads.slice(startIdx, endIdx);

      container.innerHTML = `
        <table id="calls-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>First Call</th>
              <th>Approved Date</th>
            </tr>
          </thead>
          <tbody>
            ${paginatedLeads.map(lead => `
              <tr style="${lead.conversion_detected ? 'background: rgba(0, 255, 0, 0.05); cursor: pointer; border-left: 3px solid rgba(0, 255, 0, 0.5);' : 'cursor: pointer; border-left: 3px solid rgba(0, 255, 0, 0.5);'}" onclick="showLeadDetails(${lead.id})">
                <td>
                  ${lead.name || 'Unknown Caller'}
                  ${lead.conversion_detected ? '<span style="margin-left: 8px; font-size: 18px;" title="Lead converted to client!"></span>' : ''}
                </td>
                <td style="color: #00FFFF; font-family: 'JetBrains Mono', monospace; font-size: 12px;">${lead.phone_number || 'N/A'}</td>
                <td style="color: #7d8590; font-size: 12px;">${lead.email || 'N/A'}</td>
                <td style="color: #7d8590; font-size: 12px;">${new Date(lead.first_call_date).toLocaleDateString()}</td>
                <td style="color: #00FF00; font-size: 12px;">${lead.status_updated_at ? new Date(lead.status_updated_at).toLocaleDateString() : 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        ${totalPages > 1 ? `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: rgba(13, 17, 23, 0.6); border-radius: 8px;">
            <button
              onclick="currentApprovedPage--; renderApprovedLeads(allLeadsData.filter(l => l.status === 'Approved'))"
              ${currentApprovedPage === 1 ? 'disabled' : ''}
              style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; border-radius: 6px; cursor: pointer; ${currentApprovedPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
            >
               Previous
            </button>
            <span style="color: #7d8590; font-size: 14px;">
              Page ${currentApprovedPage} of ${totalPages} (${leads.length} total approved)
            </span>
            <button
              onclick="currentApprovedPage++; renderApprovedLeads(allLeadsData.filter(l => l.status === 'Approved'))"
              ${currentApprovedPage === totalPages ? 'disabled' : ''}
              style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; border-radius: 6px; cursor: pointer; ${currentApprovedPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
            >
              Next 
            </button>
          </div>
        ` : ''}
      `;
    }

    function renderDeniedLeads(leads) {
      const container = document.getElementById('leads-denied-container');

      if (leads.length === 0) {
        container.innerHTML = `
          <div style="padding: 40px; text-align: center; color: #7d8590;">
            <p style="font-size: 16px;">No denied leads</p>
            <p style="font-size: 14px; margin-top: 10px;">Leads you deny will appear here for your records</p>
          </div>
        `;
        return;
      }

      // Pagination logic
      const totalPages = Math.ceil(leads.length / LEADS_PER_PAGE);
      const startIdx = (currentDeniedPage - 1) * LEADS_PER_PAGE;
      const endIdx = startIdx + LEADS_PER_PAGE;
      const paginatedLeads = leads.slice(startIdx, endIdx);

      container.innerHTML = `
        <table id="calls-table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Phone</th>
              <th>Email</th>
              <th>First Call</th>
              <th>Denied Date</th>
            </tr>
          </thead>
          <tbody>
            ${paginatedLeads.map(lead => `
              <tr style="cursor: pointer; opacity: 0.8; border-left: 3px solid rgba(255, 0, 0, 0.5);" onclick="showLeadDetails(${lead.id})">
                <td>${lead.name || 'Unknown Caller'}</td>
                <td style="color: #00FFFF; font-family: 'JetBrains Mono', monospace; font-size: 12px;">${lead.phone_number || 'N/A'}</td>
                <td style="color: #7d8590; font-size: 12px;">${lead.email || 'N/A'}</td>
                <td style="color: #7d8590; font-size: 12px;">${new Date(lead.first_call_date).toLocaleDateString()}</td>
                <td style="color: #FF0000; font-size: 12px;">${lead.status_updated_at ? new Date(lead.status_updated_at).toLocaleDateString() : 'N/A'}</td>
              </tr>
            `).join('')}
          </tbody>
        </table>

        ${totalPages > 1 ? `
          <div style="display: flex; justify-content: space-between; align-items: center; margin-top: 20px; padding: 15px; background: rgba(13, 17, 23, 0.6); border-radius: 8px;">
            <button
              onclick="currentDeniedPage--; renderDeniedLeads(allLeadsData.filter(l => l.status === 'Denied'))"
              ${currentDeniedPage === 1 ? 'disabled' : ''}
              style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; border-radius: 6px; cursor: pointer; ${currentDeniedPage === 1 ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
            >
               Previous
            </button>
            <span style="color: #7d8590; font-size: 14px;">
              Page ${currentDeniedPage} of ${totalPages} (${leads.length} total denied)
            </span>
            <button
              onclick="currentDeniedPage++; renderDeniedLeads(allLeadsData.filter(l => l.status === 'Denied'))"
              ${currentDeniedPage === totalPages ? 'disabled' : ''}
              style="padding: 8px 16px; background: rgba(0, 255, 255, 0.1); border: 1px solid rgba(0, 255, 255, 0.3); color: #00FFFF; border-radius: 6px; cursor: pointer; ${currentDeniedPage === totalPages ? 'opacity: 0.5; cursor: not-allowed;' : ''}"
            >
              Next 
            </button>
          </div>
        ` : ''}
      `;
    }

    async function saveLeadContactInfo(leadId) {
      try {
        // Get values from input fields
        const name = document.getElementById('edit-lead-name').value.trim();
        const phone_number = document.getElementById('edit-lead-phone').value.trim();
        const email = document.getElementById('edit-lead-email').value.trim();

        // Basic validation
        if (!name && !phone_number && !email) {
          showToast(' At least one field must be filled', 'error');
          return;
        }

        const res = await fetch(`/api/leads/${leadId}/contact`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            name: name || null,
            phone_number: phone_number || null,
            email: email || null
          })
        });

        if (!res.ok) {
          const error = await res.json();
          throw new Error(error.error || 'Failed to update contact info');
        }

        showToast(' Contact information updated successfully', 'success');

        // Reload leads to show updated data
        await loadClientLeads();

        // Close modal or show view mode
        closeModal();
      } catch (error) {
        console.error('Error saving lead contact info:', error);
        showToast(' Failed to save: ' + error.message, 'error');
      }
    }

    async function updateClientLeadStatus(leadId, newStatus) {
      if (!newStatus) return;

      try {
        const res = await fetch(`/api/leads/${leadId}/status`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ status: newStatus })
        });

        if (!res.ok) {
          throw new Error('Failed to update status');
        }

        showToast(` Lead status updated to: ${newStatus}`, 'success');

        // Reload leads to show updated data
        loadClientLeads();
      } catch (error) {
        console.error('Error updating lead status:', error);
        showToast(' Failed to update lead status: ' + error.message, 'error');
      }
    }

    function exportApprovedLeadsClient() {
      if (!currentUser || !currentUser.agent_ids || currentUser.agent_ids.length === 0) {
        showToast('No agent configured', 'error');
        return;
      }

      const agentId = currentUser.agent_ids[0];

      fetch(`/api/leads/${agentId}?status=Approved`)
        .then(res => res.json())
        .then(data => {
          const leads = data.leads || [];
          if (leads.length === 0) {
            showToast('No approved leads to export', 'error');
            return;
          }

          // Create CSV content
          const headers = ['Name', 'Phone', 'Email', 'Description', 'First Call Date', 'Status'];
          const csvRows = [headers.join(',')];

          leads.forEach(lead => {
            const row = [
              `"${lead.name || 'Unknown'}"`,
              `"${lead.phone_number || 'N/A'}"`,
              `"${lead.email || 'N/A'}"`,
              `"${(lead.incident_description || 'N/A').replace(/"/g, '""')}"`,
              `"${new Date(lead.first_call_date).toLocaleDateString()}"`,
              `"${lead.status}"`
            ];
            csvRows.push(row.join(','));
          });

          const csvContent = csvRows.join('\\n');

          // Download CSV
          const blob = new Blob([csvContent], { type: 'text/csv' });
          const url = window.URL.createObjectURL(blob);
          const a = document.createElement('a');
          a.href = url;
          a.download = `approved-leads-${new Date().toISOString().split('T')[0]}.csv`;
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);

          showToast(` Exported ${leads.length} approved leads`, 'success');
        })
        .catch(error => {
          console.error('Error exporting leads:', error);
          showToast('Failed to export leads: ' + error.message, 'error');
        });
    }

    // Initialize
    checkAuth();
  </script>
</body>
</html>
