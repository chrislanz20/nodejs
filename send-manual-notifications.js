const https = require('https');
const Anthropic = require('@anthropic-ai/sdk');
const { Resend } = require('resend');
require('dotenv').config();

const anthropic = new Anthropic({ apiKey: process.env.ANTHROPIC_API_KEY });
const resend = new Resend(process.env.RESEND_API_KEY);

async function getCallDetails(callId) {
  return new Promise((resolve, reject) => {
    const options = {
      hostname: 'api.retellai.com',
      path: '/v2/get-call/' + callId,
      method: 'GET',
      headers: {
        'Authorization': 'Bearer ' + process.env.RETELL_API_KEY
      }
    };
    const req = https.request(options, (res) => {
      let data = '';
      res.on('data', chunk => data += chunk);
      res.on('end', () => resolve(JSON.parse(data)));
    });
    req.on('error', reject);
    req.end();
  });
}

const { extractAllCallData } = require('./lib/extractAllCallData');

const recipients = [
  '17lanzch@gmail.com',
  'svasquez@courtlaw.com',
  'karzadi@courtlaw.com',
  'aestivenson@courtlaw.com',
  'info@courtlaw.com',
  'mlabrada@courtlaw.com',
  'mcruz@courtlaw.com'
];

async function sendNotification(callId, category, label) {
  console.log('\nüìß Sending: ' + label);

  const call = await getCallDetails(callId);
  const duration = Math.round((call.end_timestamp - call.start_timestamp) / 1000);
  const callTime = new Date(call.start_timestamp).toLocaleString();

  const transcript = call.transcript_object || call.transcript;
  const extracted = await extractAllCallData(transcript, category);

  const callerName = extracted?.name || 'Unknown Caller';
  const subject = 'CourtLaw Call - ' + category + ' - ' + callerName;
  const phone = call.from_number || 'N/A';
  const company = extracted?.who_representing || '';
  const caseName = extracted?.case_name || '';
  const claimNum = extracted?.claim_number || '';
  const purpose = extracted?.purpose || 'N/A';
  const summary = extracted?.call_summary || 'No summary available';

  // Build HTML email
  let html = `
    <div style="font-family: Arial, sans-serif; max-width: 600px;">
      <h2 style="color: #1a365d; border-bottom: 2px solid #3182ce; padding-bottom: 10px;">
        ${category} Call
      </h2>

      <table style="width: 100%; border-collapse: collapse; margin: 20px 0;">
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold; width: 140px;">Caller:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${callerName}</td>
        </tr>
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Phone:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${phone}</td>
        </tr>`;

  if (company) {
    html += `
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Company:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${company}</td>
        </tr>`;
  }

  if (caseName) {
    html += `
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Re:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${caseName}</td>
        </tr>`;
  }

  if (claimNum) {
    html += `
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Claim #:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${claimNum}</td>
        </tr>`;
  }

  html += `
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Purpose:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${purpose}</td>
        </tr>
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Call Time:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${callTime}</td>
        </tr>
        <tr>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0; font-weight: bold;">Duration:</td>
          <td style="padding: 8px; border-bottom: 1px solid #e2e8f0;">${duration} seconds</td>
        </tr>
      </table>

      <div style="background: #f7fafc; padding: 15px; border-radius: 8px; margin: 20px 0;">
        <h3 style="margin-top: 0; color: #2d3748;">Summary</h3>
        <p style="color: #4a5568; line-height: 1.6;">${summary}</p>
      </div>

      <p style="color: #718096; font-size: 12px; margin-top: 30px;">
        This notification was generated by CourtLaw's AI intake system.
      </p>
    </div>
  `;

  try {
    const result = await resend.emails.send({
      from: 'SaveYa Tech Notifications <notifications@saveyatech.com>',
      to: recipients,
      subject: subject,
      html: html
    });

    console.log('   ‚úÖ Sent successfully! ID: ' + result.data?.id);
    return true;
  } catch (error) {
    console.log('   ‚ùå Failed: ' + error.message);
    return false;
  }
}

async function main() {
  const callsToSend = [
    { id: 'call_7c0fba91faadf41fa2b6aadf7d8', category: 'Insurance', label: '1. Nick DiPasquale from GEICO' },
    { id: 'call_bada7e235b6ea478243b400170d', category: 'Other', label: '2. Cedra Brand seeking Michelle Labrada' },
    { id: 'call_dfe4b21da53276146488cbd250c', category: 'Other', label: '3. Karen looking for Perth Amboy office' },
    { id: 'call_601c31d0519ef69a5eaa3c3f795', category: 'Existing Client', label: '4. Elise Prias wanting lawyer callback' },
    { id: 'call_79e57bfbed8e0f210b600e6c640', category: 'Attorney', label: '5. Kevin Conyngham from Harwood Lloyd' }
  ];

  let sent = 0;
  let failed = 0;

  for (const c of callsToSend) {
    const success = await sendNotification(c.id, c.category, c.label);
    if (success) sent++;
    else failed++;
  }

  console.log('\n========================================');
  console.log('COMPLETE: ' + sent + ' sent, ' + failed + ' failed');
  console.log('========================================');
}

main().catch(console.error);
